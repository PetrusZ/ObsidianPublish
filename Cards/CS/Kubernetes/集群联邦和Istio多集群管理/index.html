<!doctype html><html lang=en><head><script async defer data-website-id=de560d7e-374a-4694-943f-f3f01b8dba46 src=https://umami.codeplayer.org:1443/umami.js></script>
<script>function _howxm(){_howxmQueue.push(arguments)}window._howxmQueue=window._howxmQueue||[],_howxm("setAppID","21c1239b-b2d0-45c5-8eab-246d8b16a9d6"),function(){if(t="howxm_script",!document.getElementById(t)){var t,e=document.createElement("script"),n=document.getElementsByTagName("script")[0];e.setAttribute("id",t),e.type="text/javascript",e.async=!0,e.src="https://static.howxm.com/sdk.js",n.parentNode.insertBefore(e,n)}}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PCXDEM5E1Q"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PCXDEM5E1Q",{anonymize_ip:!1})}</script><meta charset=utf-8><meta name=description content="集群治理的驱动力 分布式云是未来  成本优化（Cost Effective） 更好的弹性及灵活性（Elasticity&Flexibility） 避免厂商锁定（Avoid Vendor Lock-in） 第一时间获取云上的新功能（Innovation） 容灾（Resilience &Recovery） 数据保护及风险管理（Data Protection&Risk Management） 提升响应速度（NetworkPerformance Improvements）  分布式云的挑战  Kubernetes单集群承载能力有限 异构的基础设施 存量资源接入 配置变更及下发 跨地域、跨机房应用部署及管理 容灾与隔离性，异地多活 弹性调度及自动伸缩 监控告警  如何应对  通过Kubernetes 屏蔽底层基础设施，提供统一的接入层 多云架构 多集群+多云 多集群管控 统一的管控面 方便接入，降低使用门槛  跨地域的集群管理  集群联邦 集群联邦的必要性 单一集群的管理规模有上限 数据库存储"><meta property="og:title" content="集群联邦和Istio多集群管理"><meta property="og:description" content="集群治理的驱动力 分布式云是未来  成本优化（Cost Effective） 更好的弹性及灵活性（Elasticity&Flexibility） 避免厂商锁定（Avoid Vendor Lock-in） 第一时间获取云上的新功能（Innovation） 容灾（Resilience &Recovery） 数据保护及风险管理（Data Protection&Risk Management） 提升响应速度（NetworkPerformance Improvements）  分布式云的挑战  Kubernetes单集群承载能力有限 异构的基础设施 存量资源接入 配置变更及下发 跨地域、跨机房应用部署及管理 容灾与隔离性，异地多活 弹性调度及自动伸缩 监控告警  如何应对  通过Kubernetes 屏蔽底层基础设施，提供统一的接入层 多云架构 多集群+多云 多集群管控 统一的管控面 方便接入，降低使用门槛  跨地域的集群管理  集群联邦 集群联邦的必要性 单一集群的管理规模有上限 数据库存储"><meta property="og:type" content="website"><meta property="og:image" content="https://obsidian.codeplayer.org/icon.png"><meta property="og:url" content="https://obsidian.codeplayer.org/Cards/CS/Kubernetes/%E9%9B%86%E7%BE%A4%E8%81%94%E9%82%A6%E5%92%8CIstio%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="集群联邦和Istio多集群管理"><meta name=twitter:description content="集群治理的驱动力 分布式云是未来  成本优化（Cost Effective） 更好的弹性及灵活性（Elasticity&Flexibility） 避免厂商锁定（Avoid Vendor Lock-in） 第一时间获取云上的新功能（Innovation） 容灾（Resilience &Recovery） 数据保护及风险管理（Data Protection&Risk Management） 提升响应速度（NetworkPerformance Improvements）  分布式云的挑战  Kubernetes单集群承载能力有限 异构的基础设施 存量资源接入 配置变更及下发 跨地域、跨机房应用部署及管理 容灾与隔离性，异地多活 弹性调度及自动伸缩 监控告警  如何应对  通过Kubernetes 屏蔽底层基础设施，提供统一的接入层 多云架构 多集群+多云 多集群管控 统一的管控面 方便接入，降低使用门槛  跨地域的集群管理  集群联邦 集群联邦的必要性 单一集群的管理规模有上限 数据库存储"><meta name=twitter:image content="https://obsidian.codeplayer.org/icon.png"><title>集群联邦和Istio多集群管理</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://obsidian.codeplayer.org//icon.png><link href=https://obsidian.codeplayer.org/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://obsidian.codeplayer.org/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://obsidian.codeplayer.org/js/darkmode.245a0a31da505f6b327aec1fcae860c8.min.js></script>
<script src=https://obsidian.codeplayer.org/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://obsidian.codeplayer.org/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://obsidian.codeplayer.org/",fetchData=Promise.all([fetch("https://obsidian.codeplayer.org/indices/linkIndex.8aed04344c01ff4421ca534aea1f7999.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://obsidian.codeplayer.org/indices/contentIndex.7c2b577805068370d2ee945b349c6c21.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://obsidian.codeplayer.org",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://obsidian.codeplayer.org",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/obsidian.codeplayer.org\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=obsidian.codeplayer.org src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://obsidian.codeplayer.org/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://obsidian.codeplayer.org/>Avalon Obsidian Vault</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>集群联邦和Istio多集群管理</h1><p class=meta>Last updated
Apr 9, 2023
<a href=https://github.com/PetrusZ/avalon-obsidian-vault/tree/main/Cards/CS/Kubernetes/%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%92%8cIstio%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://obsidian.codeplayer.org/tags/CS/Kubernetes/>Cs kubernetes</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#集群治理的驱动力>集群治理的驱动力</a><ol><li><a href=#分布式云是未来>分布式云是未来</a></li><li><a href=#分布式云的挑战>分布式云的挑战</a></li><li><a href=#如何应对>如何应对</a></li><li><a href=#跨地域的集群管理>跨地域的集群管理</a></li><li><a href=#集群联邦>集群联邦</a><ol><li><a href=#集群联邦的必要性>集群联邦的必要性</a></li></ol></li><li><a href=#集群联邦的职责>集群联邦的职责</a></li><li><a href=#混合云-1>混合云</a></li><li><a href=#集群联邦-1>集群联邦</a></li><li><a href=#基于集群联邦的高可用应用部署>基于集群联邦的高可用应用部署</a></li><li><a href=#集群联邦核心架构>集群联邦核心架构</a></li><li><a href=#集群联邦管理的对象>集群联邦管理的对象</a></li><li><a href=#集群注册中心>集群注册中心</a></li><li><a href=#集群类型>集群类型</a></li><li><a href=#注册集群kubefedcluster>注册集群KubeFedCluster</a></li><li><a href=#kubefedcluster>KubeFedCluster</a></li><li><a href=#federation-支持的核心对象>Federation 支持的核心对象</a></li><li><a href=#type-configuration>Type Configuration</a></li><li><a href=#federatedconfigmap>FederatedConfigMap</a></li><li><a href=#联邦对象组成>联邦对象组成</a></li><li><a href=#template>Template</a></li><li><a href=#placement>Placement</a></li><li><a href=#overrides>Overrides</a></li><li><a href=#使用-federated-对象>使用 Federated 对象</a></li><li><a href=#联邦调度>联邦调度</a></li><li><a href=#多集群dns>多集群DNS</a></li><li><a href=#servicednsrecord-原理>ServiceDNSRecord 原理</a></li></ol></li><li><a href=#clusternet>Clusternet</a><ol><li><a href=#clusternet-简介>Clusternet 简介</a></li><li><a href=#clusternet-能力一览>Clusternet 能力一览</a></li><li><a href=#多集群管理的挑战>多集群管理的挑战</a></li><li><a href=#clusternet-架构>Clusternet 架构</a></li><li><a href=#clusternet-架构-1>Clusternet 架构</a></li><li><a href=#如何通过-clusternet-访问任一子集群>如何通过 Clusternet 访问任一子集群</a></li><li><a href=#clusternet-应用分发设计>Clusternet 应用分发设计</a></li><li><a href=#应用分发的差异化痛点>应用分发的差异化痛点</a></li><li><a href=#clusternet-应用分发模型>Clusternet 应用分发模型</a></li></ol></li><li><a href=#istio多集群>Istio多集群</a><ol><li><a href=#跨地域流量管理的挑战>跨地域流量管理的挑战</a></li><li><a href=#规模化带来的挑战>规模化带来的挑战</a></li><li><a href=#多集群部署>多集群部署</a></li><li><a href=#入站流量架构-l4l7>入站流量架构 L4+L7</a></li><li><a href=#单网关集群多环境支持>单网关集群多环境支持</a></li><li><a href=#应用高可用接入方案>应用高可用接入方案</a></li><li><a href=#为应用发布服务>为应用发布服务</a></li><li><a href=#创建-workloadentry>创建 WorkloadEntry</a></li><li><a href=#定义-serviceentry>定义 ServiceEntry</a></li><li><a href=#在-virtualservice-中引用-serviceentry>在 VirtualService 中引用 ServiceEntry</a></li><li><a href=#为workload-添加-locality-信息>为workload 添加 Locality 信息</a></li><li><a href=#定义基于-locality-的流量转发规则>定义基于 Locality 的流量转发规则</a></li><li><a href=#应对规模化集群挑战>应对规模化集群挑战</a></li><li><a href=#istiod-自身的规模控制>Istiod 自身的规模控制</a></li><li><a href=#基于联邦的统一流量模型>基于联邦的统一流量模型</a></li><li><a href=#统一流量模型-nameservice>统一流量模型-NameService</a></li><li><a href=#accesspoint-控制器>AccessPoint 控制器</a></li><li><a href=#未来展望>未来展望</a></li></ol></li></ol></nav></details></aside><a href=#集群治理的驱动力><h1 id=集群治理的驱动力><span class=hanchor arialabel=Anchor># </span>集群治理的驱动力</h1></a><a href=#分布式云是未来><h2 id=分布式云是未来><span class=hanchor arialabel=Anchor># </span>分布式云是未来</h2></a><ul><li><strong>成本优化</strong>（Cost Effective）</li><li>更好的弹性及灵活性（<strong>Elasticity&Flexibility</strong>）</li><li><strong>避免厂商锁定</strong>（Avoid Vendor Lock-in）</li><li>第一时间获取云上的新功能（<strong>Innovation</strong>）</li><li><strong>容灾</strong>（Resilience &Recovery）</li><li>数据保护及风险管理（<strong>Data Protection&Risk Management</strong>）</li><li><strong>提升响应速度</strong>（NetworkPerformance Improvements）</li></ul><a href=#分布式云的挑战><h2 id=分布式云的挑战><span class=hanchor arialabel=Anchor># </span>分布式云的挑战</h2></a><ul><li>Kubernetes单集群承载能力有限</li><li>异构的基础设施</li><li>存量资源接入</li><li>配置变更及下发</li><li>跨地域、跨机房应用部署及管理</li><li>容灾与隔离性，异地多活</li><li>弹性调度及自动伸缩</li><li>监控告警</li></ul><a href=#如何应对><h2 id=如何应对><span class=hanchor arialabel=Anchor># </span>如何应对</h2></a><ul><li>通过Kubernetes 屏蔽底层基础设施，提供统一的接入层</li><li>多云架构</li><li>多集群+多云</li><li>多集群管控</li><li>统一的管控面</li><li>方便接入，降低使用门槛</li></ul><a href=#跨地域的集群管理><h2 id=跨地域的集群管理><span class=hanchor arialabel=Anchor># </span>跨地域的集群管理</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667318499437_0.png width=auto alt=image.png></p><a href=#集群联邦><h2 id=集群联邦><span class=hanchor arialabel=Anchor># </span>集群联邦</h2></a><a href=#集群联邦的必要性><h3 id=集群联邦的必要性><span class=hanchor arialabel=Anchor># </span>集群联邦的必要性</h3></a><a href=#单一集群的管理规模有上限><h4 id=单一集群的管理规模有上限><span class=hanchor arialabel=Anchor># </span>单一集群的管理规模有上限</h4></a><p><strong>数据库存储</strong></p><p>etcd 作为 Kubernetes集群的后端存储数据库，对空间大小的要求比较苛刻，这限制了集群能存储的对象数量和大小。</p><p><strong>内存占用</strong></p><p>为提高系统效率，Kubernetes 的 API Server 作为 API网关，会对该集群的所有对象做缓存。集群越大，缓存需要的内存空间就越大。</p><p>其他Kubernetes 控制器也需要对侦听的对象构建客户端缓存，这些都需要占用系统内存。这些内存需求都要求对系统的规模有所限制。</p><p><strong>控制器复杂度</strong></p><p>Kubernetes 的一个业务流程是由多个对象和控制器联动完成的，即使控制器遵循了设计原则，随着对象数量的增长，控制器的处理耗时也会越来越长。</p><a href=#单个计算节点资源上限><h4 id=单个计算节点资源上限><span class=hanchor arialabel=Anchor># </span>单个计算节点资源上限</h4></a><p>单个计算节点的资源，不仅仅是CPU、内存等可量化资源。</p><p>还有端口、进程数量等不可量化资源。比如 Linux支持的 TCP端口上限是65535，去除常用端口和程序源端口后，留给 Service nodePort 的端口数量是有限的，这限制了集群支持的 Service 的数量。</p><a href=#故障域控制><h4 id=故障域控制><span class=hanchor arialabel=Anchor># </span>故障域控制</h4></a><p>集群规模越大，控制平面组件出现故障时的影响范围就越大。为了更好地控制故障域（FaultDomain），需要将大规模的数据中心切分成多个规模相对较小的集群，每个集群控制在一定规模。</p><a href=#应用高可用部署><h4 id=应用高可用部署><span class=hanchor arialabel=Anchor># </span>应用高可用部署</h4></a><p>生产应用通常需要多数据中心部署来保障跨地域高可用，以确保当其中一个数据中心出现故障，或者集群做技术迭代更新时，其他数据中心可以继续提供服务。</p><a href=#混合云><h4 id=混合云><span class=hanchor arialabel=Anchor># </span>混合云</h4></a><p>私有云加公有云的混合云模式逐渐成为企业的主流架构。</p><a href=#集群联邦的职责><h2 id=集群联邦的职责><span class=hanchor arialabel=Anchor># </span>集群联邦的职责</h2></a><ul><li>跨集群同步资源<ul><li>联邦可以将资源同步到多个集群并协调资源的分配。例如，联邦可以保证一个应用的 Deployment 被部署到多个集群中，同时能够满足全局的调度策略。</li></ul></li><li>跨集群服务发现<ul><li>联邦汇总各个集群的服务和 Ingress，并暴露到全局 DNS 服务中。</li></ul></li><li>高可用<ul><li>联邦可以动态地调整每个集群的应用实例，且隐藏了具体的集群信息。</li></ul></li><li>避免厂商锁定<ul><li>每个集群都是部署在真实的硬件或云供应商提供的硬件（或虚拟硬件）之上的，若要更换供应商，只需在新供应商提供的硬件上部署新的集群，并加入联邦。联邦可以几乎透明地将应用从原集群迁移到新集群而无须对应用做更改。</li></ul></li></ul><a href=#混合云-1><h2 id=混合云-1><span class=hanchor arialabel=Anchor># </span>混合云</h2></a><ul><li><strong>混合云是指将公有云和私有云整合在一起的统一云平台。</strong></li><li>用户业务可灵活部署或扩容在不同云中。</li><li>混合云避免厂商锁定。</li><li>混合云可支持更多复杂业务场景∶<ul><li>Cloud Burst。</li><li>如12306，低流量时运行在本地数据中心，当请求量突然爆发的时候，可以直接在公有云扩容，节省数据中心成本。</li><li>可将业务分为包含敏感数据和不包含敏感数据的业务，将敏感数据业务运行在私有云，将非敏感数据业务运行在公有云。</li><li>可重复利用公有云提供商数据中心靠近边缘的能力。</li></ul></li></ul><a href=#集群联邦-1><h2 id=集群联邦-1><span class=hanchor arialabel=Anchor># </span>集群联邦</h2></a><p><strong>集群联邦（Federation）是将多个Kubernetes 集群注册到统一控制平面，为用户提供统一API入口的多集群解决方案。</strong></p><p>集群联邦设计的核心是提供在全局层面对应用的描述能力，并将联邦对象实例化为 Kubernetes 对象，分发到联邦下辖的各个成员集群中。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667319263814_0.png width=auto alt=image.png></p><a href=#基于集群联邦的高可用应用部署><h2 id=基于集群联邦的高可用应用部署><span class=hanchor arialabel=Anchor># </span>基于集群联邦的高可用应用部署</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667319487098_0.png width=auto alt=image.png></p><a href=#集群联邦核心架构><h2 id=集群联邦核心架构><span class=hanchor arialabel=Anchor># </span>集群联邦核心架构</h2></a><p>etcd作为分布式存储后端存储所有对象；</p><p>APIServer作为API网关，接收所有来自用户及控制平面组件的请求；</p><p>不同的控制器对联邦层面的对象进行管理、协调等；</p><p>调度控制器在联邦层面对应用进行调度、分配。</p><p><strong>集群联邦支持灵活的对象扩展，允许将基本Kubernetes对象扩展为集群联邦对象，并通过统一的联邦控制器推送和收集状态。</strong></p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667322401735_0.png width=auto alt=image.png></p><a href=#集群联邦管理的对象><h2 id=集群联邦管理的对象><span class=hanchor arialabel=Anchor># </span>集群联邦管理的对象</h2></a><p><strong>成员集群是联邦的基本管理单元，所有待管理集群均须注册到集群联邦。</strong></p><p>集群联邦V2提供了统一的工具集（Kubefedct），允许用户对单个对象动态地创建联邦对象.。
动态对象的生成基于CRD。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667322442338_0.png width=auto alt=image.png></p><a href=#集群注册中心><h2 id=集群注册中心><span class=hanchor arialabel=Anchor># </span>集群注册中心</h2></a><p><strong>集群注册中心（ClusterRegistry）提供了所有联邦下辖的集群清单，以及每个集群的认证信息，状态信息等。</strong></p><p>集群联邦本身不提供算力，它只承担多集群的协调工作，所有被管理的集群都应注册到集群联邦中。</p><p>集群联邦使用了单独的KubeFedCluster 对象（同样适用CRD来定义）来管理集群注册信息：</p><ul><li>在该对象的定义中，不仅包含集群的注册信息，还包含集群的认证信息的引用，以明确每个集群使用的认证信息；</li><li>该对象还包含各个集群的健康状态、域名等；</li><li>当控制器行为出现异常时，直接通过集群状态信息即可获知控制器异常的原因。</li></ul><a href=#集群类型><h2 id=集群类型><span class=hanchor arialabel=Anchor># </span>集群类型</h2></a><p><strong>Host：</strong></p><p>用于提供KubeFed API与控制平面的集群，本质上就是 Federation控制面。</p><p><strong>Member：</strong></p><p>通过 KubeFed API注册的集群，并提供相关身份凭证来让KubeFed Controller 能够存取集群。Host集群也可以作为Member 被加入。</p><a href=#注册集群kubefedcluster><h2 id=注册集群kubefedcluster><span class=hanchor arialabel=Anchor># </span>注册集群KubeFedCluster</h2></a><p>用来定义哪些Kubernetes集群要被联邦。</p><p>可透过<strong>kubefedctl join/unjoin</strong> 来加入/删除集群，当成功加入时，会建立一个KubeFedCluster组件来储存集群相关信息，如<strong>APIEndpoint、CA Bundle</strong>等。</p><p>这些信息会被用在<strong>KubeFed Controller</strong>存取不同Kubernetes 集群上，以确保能够建立KubernetesAPI资源。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667323372563_0.png width=auto alt=image.png></p><a href=#kubefedcluster><h2 id=kubefedcluster><span class=hanchor arialabel=Anchor># </span>KubeFedCluster</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.kubefed.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeFedCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cluster1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiEndpoint</span><span class=p>:</span><span class=w> </span><span class=l>https://API Server.cluster1.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=l>LSOtLS***LSOK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>disabledTLSValidations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>‘*’</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster1-vhvfw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ClusterReady</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>China</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zones</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Shanghai</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667323641894_0.png width=auto alt=image.png></p><a href=#federation-支持的核心对象><h2 id=federation-支持的核心对象><span class=hanchor arialabel=Anchor># </span>Federation 支持的核心对象</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667323667635_0.png width=auto alt=image.png></p><a href=#type-configuration><h2 id=type-configuration><span class=hanchor arialabel=Anchor># </span>Type Configuration</h2></a><p>定义了哪些Kubernetes API资源要被用于联邦管理。</p><p>若想新增 Federated API的话，可通过<code>kubefedctlenable &lt;res></code>指令来建立。</p><p>比如说想将ConfigMap 资源通过联邦机制建立在不同集群上时，就必须先在 <strong>Federation Host</strong>集群中，通过CRD建立新资源 <strong>FederatedConfigMap</strong>，接着再建立名称为configmaps 的 Type configuration（<strong>FederatedTypeConfig</strong>）资源，然后描述ConfigMap 要被 FederatedConfigMap 所管理</p><p>这样KubeFed Controllers才能知道如何建立 Federated 资源。</p><a href=#federatedconfigmap><h2 id=federatedconfigmap><span class=hanchor arialabel=Anchor># </span>FederatedConfigMap</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k get crd federatedconfigmaps.types.kubefed.io
</span></span><span class=line><span class=cl>NAME                                  CREATEDAT
</span></span><span class=line><span class=cl>federatedconfigmaps.types.kubefed.io 2021-09-13T10:10:03Z
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>core.kubefed.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FederatedTypeConfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>federatedType</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>types.kubefed.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FederatedConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pluralName</span><span class=p>:</span><span class=w> </span><span class=l>federatedconfigmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1betal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>propagation</span><span class=p>:</span><span class=w> </span><span class=l>Enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetType</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pluralName</span><span class=p>:</span><span class=w> </span><span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#联邦对象组成><h2 id=联邦对象组成><span class=hanchor arialabel=Anchor># </span>联邦对象组成</h2></a><p>Template：定义 Kubernetes 对象的模板。</p><p>Placement：定义联邦对象需要被同步的目标集群。</p><p>Overrides：不同目标集群中，对Kubernetes 对象模板的本地化属性。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667324020820_0.png width=auto alt=image.png></p><a href=#template><h2 id=template><span class=hanchor arialabel=Anchor># </span>Template</h2></a><p><strong>Template是联邦对象中定义Kubernetes 集群对象的模板部分，它的内容为完整的Kubernetes对象。</strong></p><a href=#placement><h2 id=placement><span class=hanchor arialabel=Anchor># </span>Placement</h2></a><p>Placement用来配置联邦对象的目标集群，其值可以是具体的集群名单，也可以是clusterSeletor选择对应标签（label）的集群。</p><p>当两者同时存在时，明确定义的集群名单具有较高优先级。</p><p>联邦根据优先级来定义要同步对象的目标集群，如果提供了集群名单（哪怕是一个空List），则无论clusterSelector提供什么内容，都会被忽略。</p><a href=#overrides><h2 id=overrides><span class=hanchor arialabel=Anchor># </span>Overrides</h2></a><p>Overrides 用于针对每个集群进行本地化定制。</p><p>在实际部署应用时，通常会通过调整不同集群中的配置模板，部署符合特定集群需求的应用，以更好地发挥网络、计算资源、存储等的优势。</p><p>目前 Overrides 不支持 List（Array）。比如说无法修改</p><p>spec.template.spec.containers[0].image。</p><p>思考一下为什么</p><a href=#使用-federated-对象><h2 id=使用-federated-对象><span class=hanchor arialabel=Anchor># </span>使用 Federated 对象</h2></a><p><strong>将Namespace 设置为联邦对象</strong></p><p>kubefedctl federate ns default</p><a href=#联邦调度><h2 id=联邦调度><span class=hanchor arialabel=Anchor># </span>联邦调度</h2></a><p><strong>KubeFed</strong>提供了一种自动化机制来将工作负载实例分散到不同的集群中，这能够基于总副本数与集群的定义策略来将Deployment或ReplicaSet资源进行编排。</p><p>编排策略是通过建立<strong>ReplicaSchedulingPreference(RSP)</strong> 文件，再由KubeFed RSP Controller 监听与撷取RSP内容来将工作负载实例建立到指定的集群上。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667324454149_0.png width=auto alt=image.png></p><a href=#多集群dns><h2 id=多集群dns><span class=hanchor arialabel=Anchor># </span>多集群DNS</h2></a><p><strong>KubeFed提供了一组 API资源，以及Controllers 来实现跨集群 Service/Ingress 的 DNS records自动产生机制。</strong></p><p>需要结合 ExternalDNS来同步更新至 DNS服务供应商。</p><p>在 2020年被移出，这里提供一个DNS接入的思路。</p><a href=#servicednsrecord-原理><h2 id=servicednsrecord-原理><span class=hanchor arialabel=Anchor># </span>ServiceDNSRecord 原理</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667324649874_0.png width=auto alt=image.png></p><a href=#clusternet><h1 id=clusternet><span class=hanchor arialabel=Anchor># </span>Clusternet</h1></a><a href=#clusternet-简介><h2 id=clusternet-简介><span class=hanchor arialabel=Anchor># </span>Clusternet 简介</h2></a><p><strong>Clusternet（ClusterInternet）是一个兼具多集群管理和跨集群应用编排的开源云原生管控平台打通了跨VPC、跨地域、跨云的集群管理。</strong></p><p>Clusternet面向未来混合云、分布式云和边缘计算场景设计，支持海量集群的接入和管理。</p><p>Clusternet 在保证无侵入目轻量化的基础上，创建了一张集群网络，对子集群进行纳管，并支持多集群的应用编排与治理。</p><p>开源项目地址：https∶//github.com/clusternet/clusternet</p><a href=#clusternet-能力一览><h2 id=clusternet-能力一览><span class=hanchor arialabel=Anchor># </span>Clusternet 能力一览</h2></a><ul><li>统一管控各类<strong>Kubernetes</strong>集群；</li><li>集群管理<strong>Pull/Push</strong>模式；</li><li>轻量化，开箱即用，易于部署和维护；</li><li>跨集群的服务发现及服务互访；</li><li>Kubernetes 原生，没有额外的学习成本；</li><li>完善的<strong>RBAC</strong>能力，访问任一子集群；</li><li>完善的接入能力：<strong>kubectl plugin/client-go</strong>；</li><li>支持分发各类原生应用/<strong>CRD/HelmChart</strong>。</li></ul><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667324958372_0.png width=auto alt=image.png></p><a href=#多集群管理的挑战><h2 id=多集群管理的挑战><span class=hanchor arialabel=Anchor># </span>多集群管理的挑战</h2></a><ul><li>集群无处不在</li><li>公有云、私有云、混合云、边缘、裸金属</li><li>提供一致的纳管能力<ul><li>集群一键注册能力</li><li>一致性的集群访问体验，比如 exec，logs</li><li>权限管控 RBAC</li></ul></li><li>架构要足够轻量化，方便一键接入</li></ul><a href=#clusternet-架构><h2 id=clusternet-架构><span class=hanchor arialabel=Anchor># </span>Clusternet 架构</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667325210364_0.png width=auto alt=image.png></p><a href=#clusternet-架构-1><h2 id=clusternet-架构-1><span class=hanchor arialabel=Anchor># </span>Clusternet 架构</h2></a><ul><li>最轻量化的架构</li><li>一站式连接各类集群</li><li>支持 <strong>Pull</strong>和 <strong>Push</strong> 模式</li><li>跨集群路由访问</li><li>支持子集群 <strong>RBAC</strong>访问</li><li>提供一致的集群访问体验，比如 <strong>exec，logs</strong></li><li>原生 <strong>Kubernetes API</strong></li><li>接入成本低，<strong>kubectl plugin/client-go</strong></li></ul><a href=#如何通过-clusternet-访问任一子集群><h2 id=如何通过-clusternet-访问任一子集群><span class=hanchor arialabel=Anchor># </span>如何通过 Clusternet 访问任一子集群</h2></a><p>Clusternet支持通过Bootstrap Token，Service Token，TLS证书等RBAC的方式访问子集群；</p><p><strong>子集群的 credential信息不需要存在父集群中</strong></p><p>也支持通过kubectl命令行的方式对子集群进行 create/get/List/watch/patch/exec等操作。</p><hr><p>更详细步骤及功能可以参照</p><p><a href=https://aithub.com/clusternet/clusternet/blob/main/docs/tutorials/visiting-child-clusters-with-rbac.md rel=noopener>https://aithub.com/clusternet/clusternet/blob/main/docs/tutorials/visiting-child-clusters-with-rbac.md</a></p><ul><li>使用curl进行访问</li><li>通过kubectl进行访问</li></ul><a href=#clusternet-应用分发设计><h2 id=clusternet-应用分发设计><span class=hanchor arialabel=Anchor># </span>Clusternet 应用分发设计</h2></a><ul><li>完全兼容<strong>Kubernetes 的内置API</strong></li><li>支持 <strong>Helm Charts</strong></li><li>支持<strong>CRD</strong></li><li>丰富灵活的分发策略配置、差异化策略</li></ul><a href=#应用分发的差异化痛点><h2 id=应用分发的差异化痛点><span class=hanchor arialabel=Anchor># </span>应用分发的差异化痛点</h2></a><ol><li>在分发的资源上全部打上统一的标签，比如 apps.my.company/deployed-by∶my-platform;</li><li>在分发到子集群的资源上标记集群的信息，比如 apps.my.company/running-in∶cluster-01;</li><li>调整应用在每个集群中的副本数目、镜像名称等;</li><li>在分发到某集群前，调整应用在该集群中的一些配置，比如注入一个 Sidecar 容器等</li><li>灰度升级，变更可控，方便回滚;</li><li>重复定义怎么办?冲突吗?</li><li>&mldr;</li></ol><a href=#clusternet-应用分发模型><h2 id=clusternet-应用分发模型><span class=hanchor arialabel=Anchor># </span>Clusternet 应用分发模型</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667326114977_0.png width=auto alt=image.png></p><a href=#istio多集群><h1 id=istio多集群><span class=hanchor arialabel=Anchor># </span>Istio多集群</h1></a><a href=#跨地域流量管理的挑战><h2 id=跨地域流量管理的挑战><span class=hanchor arialabel=Anchor># </span>跨地域流量管理的挑战</h2></a><p>采用多活数据中心的网络拓扑，任何生产应用都需要完成跨三个数据中心的部署。</p><p>为满足单集群的高可用，针对每个数据中心，任何应用都需进行多副本部署，并配置负载均衡。</p><p>以实现全站微服务化，但为保证高可用，服务之间的调用仍以南北流量为主。</p><p>针对核心应用，除集群本地负载均衡配置以外，还需配置跨数据中心负载均衡，并通过权重控制将<strong>99%</strong> 的请求转入本地数据中心，将<strong>1%</strong> 的流量转向跨地域的数据中心。</p><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667373822431_0.png width=auto alt=image.png></p><a href=#规模化带来的挑战><h2 id=规模化带来的挑战><span class=hanchor arialabel=Anchor># </span>规模化带来的挑战</h2></a><ul><li>3主数据中心，20边缘数据中心，100+Kubernetes集群</li><li>规模化运营Kubernetes集群<ul><li>总计100000物理节点</li><li>单集群物理机节点规模高达5000</li></ul></li><li>业务服务全面容器化，单集群<ul><li>Pod实例可达100000</li><li>发布服务5000-10000</li></ul></li><li>单集群多环境支持<ul><li>功能测试、集成测试、压力测试共用单集群</li><li>不同环境需要彼此隔离</li></ul></li><li>异构应用<ul><li>云业务，大数据，搜索服务</li><li>多种应用协议</li><li>灰度发布</li></ul></li><li>日益增长的安全需求<ul><li>全链路TLS</li></ul></li><li>可见性需求<ul><li>访问日志</li><li>Tracing</li></ul></li></ul><a href=#多集群部署><h2 id=多集群部署><span class=hanchor arialabel=Anchor># </span>多集群部署</h2></a><ul><li>Kubernetes集群联邦<ul><li>集群联邦APIServer作为用户访问Kubernetes集群入口</li><li>所有Kubernetes 集群注册至集群联邦</li></ul></li><li>可用区<ul><li>数据中心中具有独立供电制冷设备的故障域</li><li>同一可用区有较小网络延迟</li><li>同一可用区部署了多个Kubernetes 集群</li></ul></li><li>多集群部署<ul><li>同一可用区设定一个网关集群</li><li>网关集群中部署Istio Primary</li><li>同一可用区的其他集群中部署Istio Remote</li><li>所有集群采用相同RootCA</li><li>相同环境TrustDomain相同</li></ul></li><li>东西南北流量统一管控<ul><li>同一可用区的服务调用基于Sidecar · 跨可用区的服务调用基于 Istio Gateway</li></ul></li></ul><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667375341308_0.png width=auto alt=image.png></p><a href=#入站流量架构-l4l7><h2 id=入站流量架构-l4l7><span class=hanchor arialabel=Anchor># </span>入站流量架构 L4+L7</h2></a><p><strong>为不同应用配置独立的网关服务以方便网络隔离。</strong></p><p>基于IPVS/xDP的ServiceController：</p><ul><li>四层网关调度；</li><li>虚拟IP地址分配；</li><li>基于IPIP协议的转发规则配置；</li><li>基于BGP的IP路由宣告；</li><li>在Ingress Pod中配置Tunnel设备，</li><li>并绑定虚拟IP地址以卸载IPIP包。</li></ul><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667375443775_0.png width=auto alt=image.png></p><a href=#单网关集群多环境支持><h2 id=单网关集群多环境支持><span class=hanchor arialabel=Anchor># </span>单网关集群多环境支持</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667375755323_0.png width=auto alt=image.png></p><a href=#应用高可用接入方案><h2 id=应用高可用接入方案><span class=hanchor arialabel=Anchor># </span>应用高可用接入方案</h2></a><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667376301327_0.png width=auto alt=image.png></p><a href=#为应用发布服务><h2 id=为应用发布服务><span class=hanchor arialabel=Anchor># </span>为应用发布服务</h2></a><p>定义<strong>LoadBalancer Type Service</strong>，提供集群外可访问的 <strong>LoadBalancerIlP</strong>。</p><p>其他集群可通过定义<strong>WorkloadEntry</strong>指向该<strong>LoadBalancerIP</strong>，以实现故障转移目的。</p><a href=#创建-workloadentry><h2 id=创建-workloadentry><span class=hanchor arialabel=Anchor># </span>创建 WorkloadEntry</h2></a><p><strong>创建WorkloadEntry指向其他数据中心 LoadBalancerIP</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>WorkloadEntry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>foo.bar.svc.cluster2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>locality</span><span class=p>:</span><span class=w> </span><span class=l>region1/zone1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#定义-serviceentry><h2 id=定义-serviceentry><span class=hanchor arialabel=Anchor># </span>定义 ServiceEntry</h2></a><p>同时选择WorkloadEntry和本地Pod。</p><p><strong>ServiceEntry对象可以将本地Pod和具有相同Label的WorkloadEntry定义成相同的Envoy Cluster。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceEntry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resolution</span><span class=p>:</span><span class=w> </span><span class=l>STATIC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workloadSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#在-virtualservice-中引用-serviceentry><h2 id=在-virtualservice-中引用-serviceentry><span class=hanchor arialabel=Anchor># </span>在 VirtualService 中引用 ServiceEntry</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1betal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>name:foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#为workload-添加-locality-信息><h2 id=为workload-添加-locality-信息><span class=hanchor arialabel=Anchor># </span>为workload 添加 Locality 信息</h2></a><p>Istio 从如下配置中读取，基于这些配置，我们可以为 Istio 中运行的所有 workload 添加地域属性。</p><p><strong>Kubernetes Node 对象中的地域信息，所有 Pod 自动继承该 Locality 信息</strong></p><ul><li>region: topology.kubernetes.io/region</li><li>zone: topology.kubernetes.io/zone</li><li>ubzone: topology.istio.io/subzone</li></ul><p><strong>Kubernetes Pod 的 istio-locality标签，可覆盖节点 Locality 信息</strong></p><ul><li>istio-locality: &ldquo;region/zone/subzone&rdquo;</li></ul><p><strong>WorkloadEntry 的 Locality 属性</strong></p><ul><li>locality: region/zone/subzone</li></ul><a href=#定义基于-locality-的流量转发规则><h2 id=定义基于-locality-的流量转发规则><span class=hanchor arialabel=Anchor># </span>定义基于 Locality 的流量转发规则</h2></a><p><strong>Distribute</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>localityLbSetting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>distribute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*/*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>region1/zone1/*</span><span class=p>:</span><span class=w> </span><span class=m>99</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>region2/zone2/*</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outlierDetection</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>baseEjectionTime</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>consecutive5xxErrors</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_MUTUAL</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Failover</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>foo.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>localityLbSetting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>failover</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=l>region1/zone1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=l>region2/zone2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outlierDetection</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>baseEjectionTime</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>consecutive5xxerrors</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_MUTUAL</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#应对规模化集群挑战><h2 id=应对规模化集群挑战><span class=hanchor arialabel=Anchor># </span>应对规模化集群挑战</h2></a><p><strong>Istio xDS 默认发现集群中所有的配置和服务状态，在超大规模集群中，Istiod或者 Envoy都承受比较大的压力。</strong></p><ul><li>集群中的有10000个Service，每个Service开放80和443两个端口，Istio的CDS会discover出20000个EnvoyCluster。</li><li>如果开启多集群，Istio 还会为每个cluster创建符合域名规范的集群。</li><li>Istio 还需要发现remote cluster 中的 Service，Endpoint 和 Pod 信息，而这些信息的频繁变更，会导致网络带宽占用和控制面板的压力都很大。</li></ul><p><strong>meshConfig中控制可见性∶</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>defaultServiceExportTo</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s2>&#34;.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>defaultVirtualServiceExportTo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s2>&#34;.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>defaultDestinationRuleExportTo</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s2>&#34;.&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>通过Istio对象中的exportTo属性覆盖默认配置。</strong></p><a href=#istiod-自身的规模控制><h2 id=istiod-自身的规模控制><span class=hanchor arialabel=Anchor># </span>Istiod 自身的规模控制</h2></a><p><strong>社区新增加了 discoverySelector 的支持，允许Istiod只发现添加了特定 label 的 namespaces下的Istio 以及Kubernetes 对象。</strong></p><p>但因为Kubernetes框架的限制，改功能依然要让 Istiod接收所有配置和状态变更新细，并且在Istiod 中进行对象过滤。在超大集群规模中，并未降低网络带宽占用和Istiod 的处理压力。</p><p>需要继续寻求从Kubernetes Server端过滤的解决方案。</p><a href=#基于联邦的统一流量模型><h2 id=基于联邦的统一流量模型><span class=hanchor arialabel=Anchor># </span>基于联邦的统一流量模型</h2></a><ul><li>Spec<ul><li>Scope</li><li>TrafficTemplate<ul><li>Istio models</li><li>Kubernetes Services</li></ul></li><li>Override<ul><li>可为不同目标集群修改模板属性值</li><li>支持多种override方法<ul><li>jsonPatch</li><li>mergePatch</li></ul></li></ul></li><li>Policy<ul><li>PlacementPolicy</li><li>RolloutPolicy</li><li>RuntimePolicy</li></ul></li></ul></li><li>Status<ul><li>Conditions<ul><li>四层网关状态</li><li>七层网关配置完成度</li><li>证书版本</li><li>网关服务IP和FQDN</li></ul></li></ul></li></ul><p><img src=https://obsidian.codeplayer.org//Extras/Images/image_1667393693694_0.png width=auto alt=image.png></p><a href=#统一流量模型-nameservice><h2 id=统一流量模型-nameservice><span class=hanchor arialabel=Anchor># </span>统一流量模型-NameService</h2></a><ul><li>Spec<ul><li>Global Name FQDN</li><li>TTL</li><li>DNSPolicy<ul><li>RoundRobin</li><li>Locality</li><li>Ratio</li></ul></li><li>HeathCheck Port</li><li>Target<ul><li>Target Service FQDN</li><li>Ratio</li></ul></li></ul></li><li>Status<ul><li>Conditions<ul><li>域名配置结果</li></ul></li><li>配置错误信息</li></ul></li></ul><a href=#accesspoint-控制器><h2 id=accesspoint-控制器><span class=hanchor arialabel=Anchor># </span>AccessPoint 控制器</h2></a><p><strong>PcementPolicy</strong> 控制，用户可以选择目标集群来完成流量配置，甚至可以选择关联的<strong>FederatedDeployment</strong> 对象，使得 <strong>AccessPoint</strong> 自动发现目标集群并完成配置。</p><p>完成了状态上报，包括网关虚拟<strong>IP</strong>地址，网关 <strong>FQDN</strong>，证书安装状态以及版本信息，路由策略是否配置完成等。这补齐了<strong>Istio</strong> 自身的短板，，使得任何部署在 <strong>Istio</strong> 的应用的网络配置状态一目了然。</p><p>发布策略控制，针对多集群的配置，可实现单集群的灰度发布，并且能够自动暂停发布，管理员验证单个集群的变更正确以后，再继续发布。通过此机制，避免因为全局流量变更产生的故障。</p><p>不同域名的 <strong>AccessPoint</strong> 可拥有不同的四层网关虚拟<strong>IP</strong>地址，以实现基于<strong>IP</strong>地址的四层网络隔离。</p><p>控制器可以基于<strong>AccessPoint</strong> 自动创建 <strong>WorkloadEntry</strong>，并设置 <strong>Locality</strong> 信息。</p><a href=#未来展望><h2 id=未来展望><span class=hanchor arialabel=Anchor># </span>未来展望</h2></a><ul><li>全面构建基于 Mesh 的流量管理</li><li>在用户无感知的前提下将南北流量转成东西流量</li><li>数据平面加速Cilium</li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://obsidian.codeplayer.org/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Patrick Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://obsidian.codeplayer.org/>Home</a></li><li><a href=https://github.com/PetrusZ>GitHub</a></li><li><a href=https://t.me/Petrus_Z>Telegram</a></li><li><a href=mailto:silencly07@gmail.com>Email</a></li></ul></footer></div><hr><script src=https://giscus.app/client.js data-repo=PetrusZ/ObsidianPublish data-repo-id=R_kgDOJTGL0A data-category=Announcements data-category-id=DIC_kwDOJTGL0M4CVohQ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></div></body></html>