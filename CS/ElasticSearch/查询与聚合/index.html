<!doctype html><html lang=en><head><script async defer data-website-id=de560d7e-374a-4694-943f-f3f01b8dba46 src=https://umami.codeplayer.org:1443/umami.js></script>
<script>function _howxm(){_howxmQueue.push(arguments)}window._howxmQueue=window._howxmQueue||[],_howxm("setAppID","21c1239b-b2d0-45c5-8eab-246d8b16a9d6"),function(){if(t="howxm_script",!document.getElementById(t)){var t,e=document.createElement("script"),n=document.getElementsByTagName("script")[0];e.setAttribute("id",t),e.type="text/javascript",e.async=!0,e.src="https://static.howxm.com/sdk.js",n.parentNode.insertBefore(e,n)}}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PCXDEM5E1Q"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PCXDEM5E1Q",{anonymize_ip:!1})}</script><meta charset=utf-8><meta name=description content="查询和聚合的基础使用 查询数据 查询所有 match_all表示查询所有的数据，sort即按照什么字段排序
1 2 3 4 5 6 7  GET /bank/_search { &#34;query&#34;: { &#34;match_all&#34;: {} }, &#34;sort&#34;: [ { &#34;account_number&#34;: &#34;asc&#34; } ] }   结果"><meta property="og:title" content="查询与聚合"><meta property="og:description" content="查询和聚合的基础使用 查询数据 查询所有 match_all表示查询所有的数据，sort即按照什么字段排序
1 2 3 4 5 6 7  GET /bank/_search { &#34;query&#34;: { &#34;match_all&#34;: {} }, &#34;sort&#34;: [ { &#34;account_number&#34;: &#34;asc&#34; } ] }   结果"><meta property="og:type" content="website"><meta property="og:image" content="https://obsidian.codeplayer.org/icon.png"><meta property="og:url" content="https://obsidian.codeplayer.org/CS/ElasticSearch/%E6%9F%A5%E8%AF%A2%E4%B8%8E%E8%81%9A%E5%90%88/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="查询与聚合"><meta name=twitter:description content="查询和聚合的基础使用 查询数据 查询所有 match_all表示查询所有的数据，sort即按照什么字段排序
1 2 3 4 5 6 7  GET /bank/_search { &#34;query&#34;: { &#34;match_all&#34;: {} }, &#34;sort&#34;: [ { &#34;account_number&#34;: &#34;asc&#34; } ] }   结果"><meta name=twitter:image content="https://obsidian.codeplayer.org/icon.png"><title>查询与聚合</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://obsidian.codeplayer.org//icon.png><link href=https://obsidian.codeplayer.org/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://obsidian.codeplayer.org/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://obsidian.codeplayer.org/js/darkmode.245a0a31da505f6b327aec1fcae860c8.min.js></script>
<script src=https://obsidian.codeplayer.org/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://obsidian.codeplayer.org/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://obsidian.codeplayer.org/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://obsidian.codeplayer.org/",fetchData=Promise.all([fetch("https://obsidian.codeplayer.org/indices/linkIndex.c4c4c4c7a7ef56e411497c00ff176ea1.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://obsidian.codeplayer.org/indices/contentIndex.6dab5e423942a222626678e086017f72.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://obsidian.codeplayer.org",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://obsidian.codeplayer.org",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/obsidian.codeplayer.org\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=obsidian.codeplayer.org src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://obsidian.codeplayer.org/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://obsidian.codeplayer.org/>Avalon Obsidian Vault</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>查询与聚合</h1><p class=meta>Last updated
Apr 9, 2023
<a href=https://github.com/PetrusZ/avalon-obsidian-vault/tree/main/CS/ElasticSearch/%e6%9f%a5%e8%af%a2%e4%b8%8e%e8%81%9a%e5%90%88.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://obsidian.codeplayer.org/tags/CS/ElasticSearch/>Cs elastic search</a></li></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#查询和聚合的基础使用>查询和聚合的基础使用</a><ol><li><a href=#查询数据>查询数据</a><ol><li><a href=#查询所有>查询所有</a></li><li><a href=#分页查询fromsize>分页查询(from+size)</a></li><li><a href=#指定字段查询match>指定字段查询：match</a></li><li><a href=#查询段落匹配match_phrase>查询段落匹配：match_phrase</a></li><li><a href=#多条件查询-bool>多条件查询: bool</a></li><li><a href=#查询条件query-or-filter>查询条件：query or filter</a></li></ol></li><li><a href=#聚合查询aggregation>聚合查询：Aggregation</a><ol><li><a href=#简单聚合>简单聚合</a></li><li><a href=#嵌套聚合>嵌套聚合</a></li><li><a href=#对聚合结果排序>对聚合结果排序</a></li></ol></li></ol></li><li><a href=#dsl查询>DSL查询</a><ol><li><a href=#复合查询详解>复合查询详解</a><ol><li><a href=#复合查询引入>复合查询引入</a></li><li><a href=#bool-query布尔查询>bool query(布尔查询)</a></li><li><a href=#boosting-query提高查询>boosting query(提高查询)</a></li><li><a href=#constant_score固定分数查询>constant_score（固定分数查询）</a></li><li><a href=#dis_max最佳匹配查询>dis_max(最佳匹配查询）</a></li><li><a href=#function_score函数查询>function_score(函数查询）</a></li></ol></li><li><a href=#全文搜索详解>全文搜索详解</a><ol><li><a href=#match类型>Match类型</a></li><li><a href=#query-string类型>query string类型</a></li><li><a href=#interval类型>Interval类型</a></li></ol></li><li><a href=#term详解>Term详解</a><ol><li><a href=#准备数据>准备数据</a></li><li><a href=#字段是否存在exist>字段是否存在:exist</a></li><li><a href=#id查询ids>id查询:ids</a></li><li><a href=#前缀prefix>前缀:prefix</a></li><li><a href=#分词匹配term>分词匹配:term</a></li><li><a href=#多个分词匹配terms>多个分词匹配:terms</a></li><li><a href=#按某个数字字段分词匹配term-set>按某个数字字段分词匹配:term set</a></li><li><a href=#通配符wildcard>通配符:wildcard</a></li><li><a href=#范围range>范围:range</a></li><li><a href=#正则regexp>正则:regexp</a></li><li><a href=#模糊匹配fuzzy>模糊匹配:fuzzy</a></li></ol></li><li><a href=#bucket聚合详解>Bucket聚合详解</a><ol><li><a href=#聚合的引入>聚合的引入</a></li><li><a href=#按知识点学习聚合>按知识点学习聚合</a></li><li><a href=#按分类学习bucket聚合>按分类学习Bucket聚合</a></li></ol></li><li><a href=#metric聚合详解>Metric聚合详解</a><ol><li><a href=#如何理解metric聚合>如何理解metric聚合</a></li><li><a href=#单值分析-标准stat类型>单值分析: 标准stat类型</a></li><li><a href=#min--最小值><code>min</code>   最小值</a></li><li><a href=#单值分析-其它类型>单值分析: 其它类型</a></li><li><a href=#非单值分析stats型>非单值分析：stats型</a></li><li><a href=#非单值分析百分数型>非单值分析：百分数型</a></li><li><a href=#非单值分析地理位置型>非单值分析：地理位置型</a></li><li><a href=#非单值分析top型>非单值分析：Top型</a></li></ol></li><li><a href=#pipline聚合详解>Pipline聚合详解</a><ol><li><a href=#如何理解pipeline聚合>如何理解pipeline聚合</a></li><li><a href=#一些例子>一些例子</a></li></ol></li></ol></li></ol></nav></details></aside><a href=#查询和聚合的基础使用><h1 id=查询和聚合的基础使用><span class=hanchor arialabel=Anchor># </span>查询和聚合的基础使用</h1></a><a href=#查询数据><h2 id=查询数据><span class=hanchor arialabel=Anchor># </span>查询数据</h2></a><a href=#查询所有><h3 id=查询所有><span class=hanchor arialabel=Anchor># </span>查询所有</h3></a><p><code>match_all</code>表示查询所有的数据，<code>sort</code>即按照什么字段排序</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span> <span class=s2>&#34;match_all&#34;</span>: <span class=o>{}</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span> <span class=s2>&#34;account_number&#34;</span>: <span class=s2>&#34;asc&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果</p><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_1669983783135_0.png width=auto alt=Untitled.png></p><p>相关字段解释</p><p><code>took</code> – Elasticsearch运行查询所花费的时间（以毫秒为单位）</p><p><code>timed_out</code> –搜索请求是否超时</p><p><code>_shards</code> - 搜索了多少个碎片，以及成功，失败或跳过了多少个碎片的细目分类。</p><p><code>max_score</code> – 找到的最相关文档的分数</p><p><code>hits.total.value</code> - 找到了多少个匹配的文档</p><p><code>hits.sort</code> - 文档的排序位置（不按相关性得分排序时）</p><p><code>hits._score</code> - 文档的相关性得分（使用match_all时不适用）</p><a href=#分页查询fromsize><h3 id=分页查询fromsize><span class=hanchor arialabel=Anchor># </span>分页查询(from+size)</h3></a><p>本质上就是from和size两个字段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span> <span class=s2>&#34;match_all&#34;</span>: <span class=o>{}</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span> <span class=s2>&#34;account_number&#34;</span>: <span class=s2>&#34;asc&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;from&#34;</span>: 10,
</span></span><span class=line><span class=cl><span class=s2>&#34;size&#34;</span>: <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#指定字段查询match><h3 id=指定字段查询match><span class=hanchor arialabel=Anchor># </span>指定字段查询：match</h3></a><p>如果要在字段中搜索特定字词，可以使用<code>match</code>; 如下语句将查询address 字段中包含 mill 或者 lane的数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;mill lane&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#查询段落匹配match_phrase><h3 id=查询段落匹配match_phrase><span class=hanchor arialabel=Anchor># </span>查询段落匹配：match_phrase</h3></a><p>如果我们希望查询的条件是 address字段中包含 &ldquo;mill lane&rdquo;，则可以使用<code>match_phrase</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span> <span class=s2>&#34;match_phrase&#34;</span>: <span class=o>{</span> <span class=s2>&#34;address&#34;</span>: <span class=s2>&#34;mill lane&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#多条件查询-bool><h3 id=多条件查询-bool><span class=hanchor arialabel=Anchor># </span>多条件查询: bool</h3></a><p>如果要构造更复杂的查询，可以使用<code>bool</code>查询来组合多个查询条件。</p><p>例如，以下请求在bank索引中搜索40岁客户的帐户，但不包括居住在爱达荷州（ID）的任何人</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;age&#34;</span>: <span class=s2>&#34;40&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must_not&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;state&#34;</span>: <span class=s2>&#34;ID&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#查询条件query-or-filter><h3 id=查询条件query-or-filter><span class=hanchor arialabel=Anchor># </span>查询条件：query or filter</h3></a><p>先看下如下查询, 在<code>bool</code>查询的子句中同时具备query/must 和 filter</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;state&#34;</span>: <span class=s2>&#34;ND&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;filter&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;age&#34;</span>: <span class=s2>&#34;40&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;balance&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gte&#34;</span>: 20000,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;lte&#34;</span>: <span class=m>30000</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>两者都可以写查询条件，而且语法也类似。区别在于，<strong>query 上下文的条件是用来给文档打分的，匹配越好 _score 越高；filter 的条件只产生两种结果：符合与不符合，后者被过滤掉</strong>。</p><a href=#聚合查询aggregation><h2 id=聚合查询aggregation><span class=hanchor arialabel=Anchor># </span>聚合查询：Aggregation</h2></a><blockquote><p>我们知道SQL中有group by，在ES中它叫Aggregation，即聚合运算。</p></blockquote><a href=#简单聚合><h3 id=简单聚合><span class=hanchor arialabel=Anchor># </span>简单聚合</h3></a><p>比如我们希望计算出account每个州的统计数量， 使用<code>aggs</code>关键字对<code>state</code>字段聚合，被聚合的字段无需对分词统计，所以使用<code>state.keyword</code>对整个字段统计</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl><span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;group_by_state&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;state.keyword&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_1_1669984087231_0.png width=auto alt="Untitled 1.png"></p><p>因为无需返回条件的具体数据, 所以设置size=0，返回hits为空。</p><p><code>doc_count</code>表示bucket中每个州的数据条数。</p><a href=#嵌套聚合><h3 id=嵌套聚合><span class=hanchor arialabel=Anchor># </span>嵌套聚合</h3></a><p>ES还可以处理个聚合条件的嵌套。</p><p>比如承接上个例子， 计算每个州的平均结余。涉及到的就是在对state分组的基础上，嵌套计算avg(balance):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl><span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;group_by_state&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;state.keyword&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;average_balance&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;balance&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#对聚合结果排序><h3 id=对聚合结果排序><span class=hanchor arialabel=Anchor># </span>对聚合结果排序</h3></a><p>可以通过在aggs中对嵌套聚合的结果进行排序</p><p>比如承接上个例子， 对嵌套计算出的avg(balance)，这里是average_balance，进行排序</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl><span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;group_by_state&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;state.keyword&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;order&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;average_balance&#34;</span>: <span class=s2>&#34;desc&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;average_balance&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;balance&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_2_1669984227451_0.png width=auto alt="Untitled 2.png"></p><a href=#dsl查询><h1 id=dsl查询><span class=hanchor arialabel=Anchor># </span>DSL查询</h1></a><a href=#复合查询详解><h2 id=复合查询详解><span class=hanchor arialabel=Anchor># </span>复合查询详解</h2></a><a href=#复合查询引入><h3 id=复合查询引入><span class=hanchor arialabel=Anchor># </span>复合查询引入</h3></a><p>使用<code>bool</code>查询来组合多个查询条件。</p><p>比如之前介绍的语句</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /bank/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;age&#34;</span>: <span class=s2>&#34;40&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must_not&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;state&#34;</span>: <span class=s2>&#34;ID&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这种查询就是本文要介绍的<strong>复合查询</strong>，并且bool查询只是复合查询一种。</p><a href=#bool-query布尔查询><h3 id=bool-query布尔查询><span class=hanchor arialabel=Anchor># </span>bool query(布尔查询)</h3></a><blockquote><p>通过布尔逻辑将较小的查询组合成较大的查询。</p></blockquote><a href=#概念><h4 id=概念><span class=hanchor arialabel=Anchor># </span>概念</h4></a><p>Bool查询语法有以下特点</p><p>子查询可以任意顺序出现</p><p>可以嵌套多个查询，包括bool查询</p><p>如果bool查询中没有must条件，should中必须至少满足一条才会返回结果。</p><p>bool查询包含四种操作符，分别是must,should,must_not,filter。他们均是一种数组，数组里面是对应的判断条件。</p><p><code>must</code>： 必须匹配。贡献算分</p><p><code>must_not</code>：过滤子句，必须不能匹配，但不贡献算分</p><p><code>should</code>： 选择性匹配，至少满足一条。贡献算分</p><p><code>filter</code>： 过滤子句，必须匹配，但不贡献算分</p><a href=#例子><h4 id=例子><span class=hanchor arialabel=Anchor># </span>例子</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST _search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;bool&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;term&#34;</span> : <span class=o>{</span> <span class=s2>&#34;user.id&#34;</span> : <span class=s2>&#34;kimchy&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;filter&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;term&#34;</span> : <span class=o>{</span> <span class=s2>&#34;tags&#34;</span> : <span class=s2>&#34;production&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;must_not&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;range&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;age&#34;</span> : <span class=o>{</span> <span class=s2>&#34;gte&#34;</span> : 10, <span class=s2>&#34;lte&#34;</span> : <span class=m>20</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;should&#34;</span> : <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;term&#34;</span> : <span class=o>{</span> <span class=s2>&#34;tags&#34;</span> : <span class=s2>&#34;env1&#34;</span> <span class=o>}</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=o>{</span> <span class=s2>&#34;term&#34;</span> : <span class=o>{</span> <span class=s2>&#34;tags&#34;</span> : <span class=s2>&#34;deployed&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;minimum_should_match&#34;</span> : 1,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;boost&#34;</span> : 1.0
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#boosting-query提高查询><h3 id=boosting-query提高查询><span class=hanchor arialabel=Anchor># </span>boosting query(提高查询)</h3></a><blockquote><p>不同于bool查询，bool查询中只要一个子查询条件不匹配那么搜索的数据就不会出现。而boosting query则是降低显示的权重/优先级（即score)。</p></blockquote><a href=#概念-1><h4 id=概念-1><span class=hanchor arialabel=Anchor># </span>概念</h4></a><p>比如搜索逻辑是 name = &lsquo;apple&rsquo; and type =&lsquo;fruit&rsquo;，对于只满足部分条件的数据，不是不显示，而是降低显示的优先级（即score)</p><a href=#例子-1><h4 id=例子-1><span class=hanchor arialabel=Anchor># </span>例子</h4></a><p>首先创建数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /test-dsl-boosting/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;content&#34;</span>:<span class=s2>&#34;Apple Mac&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;content&#34;</span>:<span class=s2>&#34;Apple Fruit&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>3</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;content&#34;</span>:<span class=s2>&#34;Apple employee like Apple Pie and Apple Juice&#34;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对匹配<code>pie</code>的做降级显示处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-boosting/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;boosting&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;positive&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span>: <span class=s2>&#34;apple&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;negative&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;content&#34;</span>: <span class=s2>&#34;pie&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;negative_boost&#34;</span>: 0.5
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果如下</p><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_3_1669984452609_0.png width=auto alt="Untitled 3.png"></p><a href=#constant_score固定分数查询><h3 id=constant_score固定分数查询><span class=hanchor arialabel=Anchor># </span>constant_score（固定分数查询）</h3></a><blockquote><p>查询某个条件时，固定的返回指定的score；显然当不需要计算score时，只需要filter条件即可，因为filter context忽略score。</p></blockquote><a href=#例子-2><h4 id=例子-2><span class=hanchor arialabel=Anchor># </span>例子</h4></a><p>首先创建数据</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /test-dsl-constant/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;content&#34;</span>:<span class=s2>&#34;Apple Mac&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;content&#34;</span>:<span class=s2>&#34;Apple Fruit&#34;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>查询apple</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-constant/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;constant_score&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;filter&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;term&#34;</span>: <span class=o>{</span> <span class=s2>&#34;content&#34;</span>: <span class=s2>&#34;apple&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;boost&#34;</span>: 1.2
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_4_1669984505827_0.png width=auto alt="Untitled 4.png"></p><a href=#dis_max最佳匹配查询><h3 id=dis_max最佳匹配查询><span class=hanchor arialabel=Anchor># </span>dis_max(最佳匹配查询）</h3></a><blockquote><p>分离最大化查询（Disjunction Max Query）指的是： 将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回 。</p></blockquote><a href=#例子-3><h4 id=例子-3><span class=hanchor arialabel=Anchor># </span>例子</h4></a><p>假设有个网站允许用户搜索博客的内容，以下面两篇博客内容文档为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /test-dsl-dis-max/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Quick brown rabbits&#34;</span>,<span class=s2>&#34;body&#34;</span>:  <span class=s2>&#34;Brown rabbits are commonly seen.&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Keeping pets healthy&#34;</span>,<span class=s2>&#34;body&#34;</span>:  <span class=s2>&#34;My quick brown fox eats rabbits on a regular basis.&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>用户输入词组 “Brown fox” 然后点击搜索按钮。事先，我们并不知道用户的搜索项是会在 title 还是在 body 字段中被找到，但是，用户很有可能是想搜索相关的词组。用肉眼判断，文档 2 的匹配度更高，因为它同时包括要查找的两个词：</p><p>现在运行以下 bool 查询：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-dis-max/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;should&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Brown fox&#34;</span> <span class=o>}}</span>,
</span></span><span class=line><span class=cl>              <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;body&#34;</span>:  <span class=s2>&#34;Brown fox&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>          <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_5_1669984671810_0.png width=auto alt="Untitled 5.png"></p><p><strong>引入了dis_max</strong></p><p>不使用 bool 查询，可以使用 dis_max 即分离 最大化查询（Disjunction Max Query） 。分离（Disjunction）的意思是 或（or） ，这与可以把结合（conjunction）理解成 与（and） 相对应。分离最大化查询（Disjunction Max Query）指的是： 将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回 ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-dis-max/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;dis_max&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;queries&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Brown fox&#34;</span> <span class=o>}}</span>,
</span></span><span class=line><span class=cl>              <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;body&#34;</span>:  <span class=s2>&#34;Brown fox&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>          <span class=o>]</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;tie_breaker&#34;</span>: <span class=m>0</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_6_1669984695930_0.png width=auto alt="Untitled 6.png"></p><a href=#function_score函数查询><h3 id=function_score函数查询><span class=hanchor arialabel=Anchor># </span>function_score(函数查询）</h3></a><blockquote><p>简而言之就是用自定义function的方式来计算_score。</p></blockquote><p>可以ES有哪些自定义function呢？</p><p><code>script_score</code> 使用自定义的脚本来完全控制分值计算逻辑。如果你需要以上预定义函数之外的功能，可以根据需要通过脚本进行实现。</p><p><code>weight</code> 对每份文档适用一个简单的提升，且该提升不会被归约：当weight为2时，结果为2 * _score。</p><p><code>random_score</code> 使用一致性随机分值计算来对每个用户采用不同的结果排序方式，对相同用户仍然使用相同的排序方式。</p><p><code>field_value_factor</code> 使用文档中某个字段的值来改变_score，比如将受欢迎程度或者投票数量考虑在内。</p><p><code>衰减函数(Decay Function)</code> - <code>linear</code>，<code>exp</code>，<code>gauss</code></p><a href=#全文搜索详解><h2 id=全文搜索详解><span class=hanchor arialabel=Anchor># </span>全文搜索详解</h2></a><blockquote><p>DSL查询极为常用的是对文本进行搜索，我们叫全文搜索，本文主要对全文搜索进行详解。</p></blockquote><a href=#match类型><h3 id=match类型><span class=hanchor arialabel=Anchor># </span>Match类型</h3></a><a href=#match-查询的步骤><h4 id=match-查询的步骤><span class=hanchor arialabel=Anchor># </span>match 查询的步骤</h4></a><p><strong>准备一些数据</strong></p><p>这里我们准备一些数据，通过实例看match 查询的步骤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT /test-dsl-match
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;settings&#34;</span>: <span class=o>{</span> <span class=s2>&#34;number_of_shards&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /test-dsl-match/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;The quick brown fox&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;The quick brown fox jumps over the lazy dog&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>3</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;The quick brown fox jumps over the quick dog&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>4</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;Brown fox brown dog&#34;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>查询数据</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;QUICK!&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Elasticsearch 执行上面这个 match 查询的步骤是：</p><ol><li><p><strong>检查字段类型</strong> 。
标题 title 字段是一个 string 类型（ analyzed ）已分析的全文字段，这意味着查询字符串本身也应该被分析。</p></li><li><p><strong>分析查询字符串</strong> 。
将查询的字符串 QUICK! 传入标准分析器中，输出的结果是单个项 quick 。因为只有一个单词项，所以 match 查询执行的是单个底层 term 查询。</p></li><li><p><strong>查找匹配文档</strong> 。
用 term 查询在倒排索引中查找 quick 然后获取一组包含该项的文档，本例的结果是文档：1、2 和 3 。</p></li><li><p><strong>为每个文档评分</strong> 。
用 term 查询计算每个文档相关度评分 _score ，这是种将词频（term frequency，即词 quick 在相关文档的 title 字段中出现的频率）和反向文档频率（inverse document frequency，即词 quick 在所有文档的 title 字段中出现的频率），以及字段的长度（即字段越短相关度越高）相结合的计算方式。</p></li></ol><p><strong>验证结果</strong></p><p><img src=https://obsidian.codeplayer.org//Assets/Untitled_7_1669985231196_0.png width=auto alt="Untitled 7.png"></p><a href=#match多个词深入><h4 id=match多个词深入><span class=hanchor arialabel=Anchor># </span>match多个词深入</h4></a><p>我们在上文中复合查询中已经使用了match多个词，比如“Quick pets”； 这里我们通过例子带你更深入理解match多个词</p><p><strong>match多个词的本质</strong></p><p>查询多个词"BROWN DOG!"</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;BROWN DOG&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-5.png width=auto alt></p><p>因为 match 查询必须查找两个词（ [&ldquo;brown&rdquo;,&ldquo;dog&rdquo;] ），它在内部实际上先执行两次 term 查询，然后将两次查询的结果合并作为最终结果输出。为了做到这点，它将两个 term 查询包入一个 bool 查询中，</p><p>所以上述查询的结果，和如下语句查询结果是等同的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;should&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;brown&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;dog&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>match多个词的逻辑</strong></p><p>上面等同于should（任意一个满足），是因为 match还有一个operator参数，默认是or, 所以对应的是should。</p><p>所以上述查询也等同于</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;BROWN DOG&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;operator&#34;</span>: <span class=s2>&#34;or&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>那么我们如果是需要and操作呢，即同时满足呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;BROWN DOG&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;operator&#34;</span>: <span class=s2>&#34;and&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>等同于</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;must&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;brown&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;dog&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-7.png width=auto alt></p><a href=#控制match的匹配精度><h4 id=控制match的匹配精度><span class=hanchor arialabel=Anchor># </span>控制match的匹配精度</h4></a><p>如果用户给定 3 个查询词，想查找至少包含其中 2 个的文档，该如何处理？将 operator 操作符参数设置成 and 或者 or 都是不合适的。</p><p>match 查询支持 minimum_should_match 最小匹配参数，这让我们可以指定必须匹配的词项数用来表示一个文档是否相关。我们可以将其设置为某个具体数字，更常用的做法是将其设置为一个百分数，因为我们无法控制用户搜索时输入的单词数量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>:                <span class=s2>&#34;quick brown dog&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;minimum_should_match&#34;</span>: <span class=s2>&#34;75%&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当给定百分比的时候， minimum_should_match 会做合适的事情：在之前三词项的示例中， 75% 会自动被截断成 66.6% ，即三个里面两个词。无论这个值设置成什么，至少包含两个词项的文档才会被认为是匹配的。</p><p>当然也等同于</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bool&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;should&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;quick&#34;</span> <span class=o>}}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;brown&#34;</span>   <span class=o>}}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;dog&#34;</span>   <span class=o>}}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;minimum_should_match&#34;</span>: <span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#其它match类型><h4 id=其它match类型><span class=hanchor arialabel=Anchor># </span>其它match类型</h4></a><a href=#match_pharse><h5 id=match_pharse><span class=hanchor arialabel=Anchor># </span>match_pharse</h5></a><p>match_phrase在前文中我们已经有了解，我们再看下另外一个例子。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match_phrase&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;quick brown&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-11.png width=auto alt></p><p>很多人对它仍然有误解的，比如如下例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match_phrase&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;quick brown f&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样的查询是查不出任何数据的，因为前文中我们知道了match本质上是对term组合，match_phrase本质是连续的term的查询，所以f并不是一个分词，不满足term查询，所以最终查不出任何内容了。</p><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-12.png width=auto alt></p><a href=#match_pharse_prefix><h5 id=match_pharse_prefix><span class=hanchor arialabel=Anchor># </span>match_pharse_prefix</h5></a><p>那有没有可以查询出<code>quick brown f</code>的方式呢？ELasticSearch在match_phrase基础上提供了一种可以查最后一个词项是前缀的方法，这样就可以查询<code>quick brown f</code>了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match_phrase_prefix&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;quick brown f&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-13.png width=auto alt></p><p>(ps: prefix的意思不是整个text的开始匹配，而是最后一个词项满足term的prefix查询而已)</p><a href=#match_bool_prefix><h5 id=match_bool_prefix><span class=hanchor arialabel=Anchor># </span>match_bool_prefix</h5></a><p>除了match_phrase_prefix，ElasticSearch还提供了match_bool_prefix查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match_bool_prefix&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;quick brown f&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-14.png width=auto alt></p><p>它们两种方式有啥区别呢？match_bool_prefix本质上可以转换为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bool&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;should&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;term&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;quick&#34;</span> <span class=o>}}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;term&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;brown&#34;</span> <span class=o>}}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span> <span class=s2>&#34;prefix&#34;</span>: <span class=o>{</span> <span class=s2>&#34;title&#34;</span>: <span class=s2>&#34;f&#34;</span><span class=o>}}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>所以这样你就能理解，match_bool_prefix查询中的quick,brown,f是无序的。</p><a href=#multi_match><h5 id=multi_match><span class=hanchor arialabel=Anchor># </span>multi_match</h5></a><p>如果我们期望一次对多个字段查询，怎么办呢？ElasticSearch提供了multi_match查询的方式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;multi_match&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;query&#34;</span>:    <span class=s2>&#34;Will Smith&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;fields&#34;</span>: <span class=o>[</span> <span class=s2>&#34;title&#34;</span>, <span class=s2>&#34;*_name&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>*</code>表示前缀匹配字段。</p><a href=#query-string类型><h3 id=query-string类型><span class=hanchor arialabel=Anchor># </span>query string类型</h3></a><a href=#query_string><h4 id=query_string><span class=hanchor arialabel=Anchor># </span>query_string</h4></a><p>此查询使用语法根据运算符（例如AND或）来解析和拆分提供的查询字符串NOT。然后查询在返回匹配的文档之前独立分析每个拆分的文本。</p><p>可以使用该query_string查询创建一个复杂的搜索，其中包括通配符，跨多个字段的搜索等等。尽管用途广泛，但查询是严格的，如果查询字符串包含任何无效语法，则返回错误。</p><p>例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;query_string&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;(lazy dog) OR (brown dog)&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;default_field&#34;</span>: <span class=s2>&#34;title&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里查询结果，你需要理解本质上查询这四个分词（term）or的结果而已，所以doc 3和4也在其中</p><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-15.png width=auto alt></p><a href=#query_string_simple><h4 id=query_string_simple><span class=hanchor arialabel=Anchor># </span>query_string_simple</h4></a><p>该查询使用一种简单的语法来解析提供的查询字符串并将其拆分为基于特殊运算符的术语。然后查询在返回匹配的文档之前独立分析每个术语。</p><p>尽管其语法比query_string查询更受限制 ，但<strong>simple_query_string 查询不会针对无效语法返回错误。而是，它将忽略查询字符串的任何无效部分</strong>。</p><p>举例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;simple_query_string&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span>: <span class=s2>&#34;\&#34;over the\&#34; + (lazy | quick) + dog&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;fields&#34;</span>: <span class=o>[</span><span class=s2>&#34;title&#34;</span><span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;default_operator&#34;</span>: <span class=s2>&#34;and&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-16.png width=auto alt></p><a href=#interval类型><h3 id=interval类型><span class=hanchor arialabel=Anchor># </span>Interval类型</h3></a><p>Intervals是时间间隔的意思，本质上将多个规则按照顺序匹配。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-match/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;intervals&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;title&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;all_of&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;ordered&#34;</span> : true,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;intervals&#34;</span> : <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;match&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span> : <span class=s2>&#34;quick&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;max_gaps&#34;</span> : 0,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;ordered&#34;</span> : <span class=nb>true</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;any_of&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;intervals&#34;</span> : <span class=o>[</span>
</span></span><span class=line><span class=cl>                  <span class=o>{</span> <span class=s2>&#34;match&#34;</span> : <span class=o>{</span> <span class=s2>&#34;query&#34;</span> : <span class=s2>&#34;jump over&#34;</span> <span class=o>}</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>                  <span class=o>{</span> <span class=s2>&#34;match&#34;</span> : <span class=o>{</span> <span class=s2>&#34;query&#34;</span> : <span class=s2>&#34;quick dog&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-full-text-17.png width=auto alt></p><p>因为interval之间是可以组合的，所以它可以表现的很复杂。</p><a href=#term详解><h2 id=term详解><span class=hanchor arialabel=Anchor># </span>Term详解</h2></a><a href=#准备数据><h3 id=准备数据><span class=hanchor arialabel=Anchor># </span>准备数据</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT /test-dsl-term-level
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;mappings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;properties&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;keyword&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;keyword&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;required_matches&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;long&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /test-dsl-term-level/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Jane Smith&#34;</span>, <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>[</span> <span class=s2>&#34;c++&#34;</span>, <span class=s2>&#34;java&#34;</span> <span class=o>]</span>, <span class=s2>&#34;required_matches&#34;</span>: 2<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>2</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Jason Response&#34;</span>, <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>[</span> <span class=s2>&#34;java&#34;</span>, <span class=s2>&#34;php&#34;</span> <span class=o>]</span>, <span class=s2>&#34;required_matches&#34;</span>: 2<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{</span> <span class=s2>&#34;_id&#34;</span>: <span class=m>3</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Dave Pdai&#34;</span>, <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>[</span> <span class=s2>&#34;java&#34;</span>, <span class=s2>&#34;c++&#34;</span>, <span class=s2>&#34;php&#34;</span> <span class=o>]</span>, <span class=s2>&#34;required_matches&#34;</span>: 3, <span class=s2>&#34;remarks&#34;</span>: <span class=s2>&#34;hello world&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#字段是否存在exist><h3 id=字段是否存在exist><span class=hanchor arialabel=Anchor># </span>字段是否存在:exist</h3></a><p>由于多种原因，文档字段的索引值可能不存在：</p><p>源JSON中的字段是null或[]</p><p>该字段已"index" : false在映射中设置</p><p>字段值的长度超出ignore_above了映射中的设置</p><p>字段值格式错误，并且ignore_malformed已在映射中定义</p><p>所以exist表示查找是否存在字段。</p><p><img src=https://pdai.tech/images/db/es/es-dsl-term-2.png width=auto alt></p><a href=#id查询ids><h3 id=id查询ids><span class=hanchor arialabel=Anchor># </span>id查询:ids</h3></a><p>ids 即对id查找</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ids&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;values&#34;</span>: <span class=o>[</span>3, 1<span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-3.png width=auto alt></p><a href=#前缀prefix><h3 id=前缀prefix><span class=hanchor arialabel=Anchor># </span>前缀:prefix</h3></a><p>通过前缀查找某个字段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;prefix&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;Jan&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-4.png width=auto alt></p><a href=#分词匹配term><h3 id=分词匹配term><span class=hanchor arialabel=Anchor># </span>分词匹配:term</h3></a><p>前文最常见的根据分词查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;term&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;programming_languages&#34;</span>: <span class=s2>&#34;php&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-5.png width=auto alt></p><a href=#多个分词匹配terms><h3 id=多个分词匹配terms><span class=hanchor arialabel=Anchor># </span>多个分词匹配:terms</h3></a><p>按照多个分词term匹配，它们是or的关系</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>[</span><span class=s2>&#34;php&#34;</span>,<span class=s2>&#34;c++&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-6.png width=auto alt></p><a href=#按某个数字字段分词匹配term-set><h3 id=按某个数字字段分词匹配term-set><span class=hanchor arialabel=Anchor># </span>按某个数字字段分词匹配:term set</h3></a><p>设计这种方式查询的初衷是用文档中的数字字段动态匹配查询满足term的个数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;terms_set&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;programming_languages&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;terms&#34;</span>: <span class=o>[</span> <span class=s2>&#34;java&#34;</span>, <span class=s2>&#34;php&#34;</span> <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;minimum_should_match_field&#34;</span>: <span class=s2>&#34;required_matches&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-7.png width=auto alt></p><a href=#通配符wildcard><h3 id=通配符wildcard><span class=hanchor arialabel=Anchor># </span>通配符:wildcard</h3></a><p>通配符匹配，比如<code>*</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;wildcard&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;D*ai&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;boost&#34;</span>: 1.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;rewrite&#34;</span>: <span class=s2>&#34;constant_score&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-8.png width=auto alt></p><a href=#范围range><h3 id=范围range><span class=hanchor arialabel=Anchor># </span>范围:range</h3></a><p>常常被用在数字或者日期范围的查询</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;required_matches&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gte&#34;</span>: 3,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lte&#34;</span>: <span class=m>4</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-9.png width=auto alt></p><a href=#正则regexp><h3 id=正则regexp><span class=hanchor arialabel=Anchor># </span>正则:regexp</h3></a><p>通过
<a href=https://pdai.tech/md/develop/regex/dev-regex-all.html rel=noopener>正则表达式</a>查询</p><p>以"Jan"开头的name字段</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;regexp&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;Ja.*&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;case_insensitive&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-10.png width=auto alt></p><a href=#模糊匹配fuzzy><h3 id=模糊匹配fuzzy><span class=hanchor arialabel=Anchor># </span>模糊匹配:fuzzy</h3></a><p>官方文档对模糊匹配：编辑距离是将一个术语转换为另一个术语所需的一个字符更改的次数。这些更改可以包括：</p><p>更改字符（box→ fox）</p><p>删除字符（black→ lack）</p><p>插入字符（sic→ sick）</p><p>转置两个相邻字符（act→ cat）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-dsl-term-level/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fuzzy&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;remarks&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;hell&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-dsl-term-11.png width=auto alt>
聚合查询</p><a href=#bucket聚合详解><h2 id=bucket聚合详解><span class=hanchor arialabel=Anchor># </span>Bucket聚合详解</h2></a><a href=#聚合的引入><h3 id=聚合的引入><span class=hanchor arialabel=Anchor># </span>聚合的引入</h3></a><p>我们在SQL结果中常有：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SELECT COUNT(color)
</span></span><span class=line><span class=cl>FROM table
</span></span><span class=line><span class=cl>GROUP BY color
</span></span></code></pre></td></tr></table></div></div><p>ElasticSearch中<strong>桶</strong>在概念上类似于 SQL 的分组（<code>GROUP BY</code>），而<strong>指标</strong>则类似于 <code>COUNT()</code> 、 <code>SUM()</code> 、 <code>MAX()</code> 等统计方法。</p><p>进而引入了两个概念：</p><p><strong>桶（Buckets）</strong> 满足特定条件的文档的集合</p><p><strong>指标（Metrics）</strong> 对桶内的文档进行统计计算</p><p>所以ElasticSearch包含3种聚合（Aggregation)方式</p><p><strong>桶聚合（Bucket Aggregation)</strong> - 本文中详解</p><p><strong>指标聚合（Metric Aggregation)</strong> - 下文中讲解</p><p><strong>管道聚合（Pipline Aggregation)</strong> - 再下一篇讲解</p><p>聚合管道化，简单而言就是上一个聚合的结果成为下个聚合的输入；</p><p>（PS:指标聚合和桶聚合很多情况下是组合在一起使用的，其实你也可以看到，桶聚合本质上是一种特殊的指标聚合，它的聚合指标就是数据的条数count)</p><a href=#按知识点学习聚合><h3 id=按知识点学习聚合><span class=hanchor arialabel=Anchor># </span>按知识点学习聚合</h3></a><a href=#准备数据-1><h4 id=准备数据-1><span class=hanchor arialabel=Anchor># </span>准备数据</h4></a><p>让我们先看一个例子。我们将会创建一些对汽车经销商有用的聚合，数据是关于汽车交易的信息：车型、制造商、售价、何时被出售等。</p><p>首先我们批量索引一些数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /test-agg-cars/_bulk
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 10000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;red&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;honda&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-10-28&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 20000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;red&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;honda&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-11-05&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 30000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;green&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;ford&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-05-18&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 15000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;blue&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;toyota&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-07-02&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 12000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;green&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;toyota&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-08-19&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 20000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;red&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;honda&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-11-05&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 80000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;red&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;bmw&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-01-01&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;price&#34;</span> : 25000, <span class=s2>&#34;color&#34;</span> : <span class=s2>&#34;blue&#34;</span>, <span class=s2>&#34;make&#34;</span> : <span class=s2>&#34;ford&#34;</span>, <span class=s2>&#34;sold&#34;</span> : <span class=s2>&#34;2014-02-12&#34;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#标准的聚合><h4 id=标准的聚合><span class=hanchor arialabel=Anchor># </span>标准的聚合</h4></a><p>有了数据，开始构建我们的第一个聚合。汽车经销商可能会想知道哪个颜色的汽车销量最好，用聚合可以轻易得到结果，用 terms 桶操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;aggs&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;popular_colors&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;terms&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;field&#34;</span> : <span class=s2>&#34;color.keyword&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>聚合操作被置于顶层参数 aggs 之下（如果你愿意，完整形式 aggregations 同样有效）。</li><li>然后，可以为聚合指定一个我们想要名称，本例中是： popular_colors 。</li><li>最后，定义单个桶的类型 terms 。</li></ol><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-3.png width=auto alt></p><p>因为我们设置了 size 参数，所以不会有 hits 搜索结果返回。</p><p>popular_colors 聚合是作为 aggregations 字段的一部分被返回的。</p><p>每个桶的 key 都与 color 字段里找到的唯一词对应。它总会包含 doc_count 字段，告诉我们包含该词项的文档数量。</p><p>每个桶的数量代表该颜色的文档数量。</p><a href=#多个聚合><h4 id=多个聚合><span class=hanchor arialabel=Anchor># </span>多个聚合</h4></a><p>同时计算两种桶的结果：对color和对make。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;aggs&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;popular_colors&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;terms&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;field&#34;</span> : <span class=s2>&#34;color.keyword&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;make_by&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;terms&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;field&#34;</span> : <span class=s2>&#34;make.keyword&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-4.png width=auto alt></p><a href=#聚合的嵌套><h4 id=聚合的嵌套><span class=hanchor arialabel=Anchor># </span>聚合的嵌套</h4></a><p>这个新的聚合层让我们可以将 avg 度量嵌套置于 terms 桶内。实际上，这就为每个颜色生成了平均价格。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;colors&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;color.keyword&#34;</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_price&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span>
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-5.png width=auto alt></p><p>正如 颜色 的例子，我们需要给度量起一个名字（ avg_price ）这样可以稍后根据名字获取它的值。最后，我们指定度量本身（ avg ）以及我们想要计算平均值的字段（ price ）</p><a href=#动态脚本的聚合><h4 id=动态脚本的聚合><span class=hanchor arialabel=Anchor># </span>动态脚本的聚合</h4></a><p>这个例子告诉你，ElasticSearch还支持一些基于脚本（生成运行时的字段）的复杂的动态聚合。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;runtime_mappings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;make.length&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;long&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;script&#34;</span>: <span class=s2>&#34;emit(doc[&#39;make.keyword&#39;].value.length())&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;make_length&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;histogram&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;interval&#34;</span>: 1,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;make.length&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-6.png width=auto alt></p><a href=#按分类学习bucket聚合><h3 id=按分类学习bucket聚合><span class=hanchor arialabel=Anchor># </span>按分类学习Bucket聚合</h3></a><blockquote><p>我们在具体学习时，也无需学习每一个点，基于上面图的认知，我们只需用20%的时间学习最为常用的80%功能即可，其它查查文档而已。@pdai</p></blockquote><a href=#前置条件的过滤filter><h4 id=前置条件的过滤filter><span class=hanchor arialabel=Anchor># </span>前置条件的过滤：filter</h4></a><p>在当前文档集上下文中定义与指定过滤器(Filter)匹配的所有文档的单个存储桶。通常，这将用于将当前聚合上下文缩小到一组特定的文档。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;make_by&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;filter&#34;</span>: <span class=o>{</span> <span class=s2>&#34;term&#34;</span>: <span class=o>{</span> <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;honda&#34;</span> <span class=o>}</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;avg_price&#34;</span>: <span class=o>{</span> <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-7.png width=auto alt></p><a href=#对filter进行分组聚合filters><h4 id=对filter进行分组聚合filters><span class=hanchor arialabel=Anchor># </span>对filter进行分组聚合：filters</h4></a><p>设计一个新的例子, 日志系统中，每条日志都是在文本中，包含warning/info等信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT /test-agg-logs/_bulk?refresh
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span> : <span class=o>{</span> <span class=s2>&#34;_id&#34;</span> : <span class=m>1</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;warning: page could not be rendered&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span> : <span class=o>{</span> <span class=s2>&#34;_id&#34;</span> : <span class=m>2</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;authentication error&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span> : <span class=o>{</span> <span class=s2>&#34;_id&#34;</span> : <span class=m>3</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;warning: connection timed out&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;index&#34;</span> : <span class=o>{</span> <span class=s2>&#34;_id&#34;</span> : <span class=m>4</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;info: hello pdai&#34;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们需要对包含不同日志类型的日志进行分组，这就需要filters:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-logs/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;filters&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;other_bucket_key&#34;</span>: <span class=s2>&#34;other_messages&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;filters&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;infos&#34;</span> :   <span class=o>{</span> <span class=s2>&#34;match&#34;</span> : <span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;info&#34;</span>   <span class=o>}}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;warnings&#34;</span> : <span class=o>{</span> <span class=s2>&#34;match&#34;</span> : <span class=o>{</span> <span class=s2>&#34;body&#34;</span> : <span class=s2>&#34;warning&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-8.png width=auto alt></p><a href=#对number类型聚合range><h4 id=对number类型聚合range><span class=hanchor arialabel=Anchor># </span>对number类型聚合：Range</h4></a><p>基于多桶值源的聚合，使用户能够定义一组范围-每个范围代表一个桶。在聚合过程中，将从每个存储区范围中检查从每个文档中提取的值，并“存储”相关/匹配的文档。请注意，此聚合包括from值，但不包括to每个范围的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;price_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;to&#34;</span>: <span class=m>20000</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;from&#34;</span>: 20000, <span class=s2>&#34;to&#34;</span>: <span class=m>40000</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;from&#34;</span>: <span class=m>40000</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-9.png width=auto alt>{:height 452, :width 654}</p><a href=#对ip类型聚合ip-range><h4 id=对ip类型聚合ip-range><span class=hanchor arialabel=Anchor># </span>对IP类型聚合：IP Range</h4></a><p>专用于IP值的范围聚合。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /ip_addresses/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 10,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ip_range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;ip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;buckets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;*-10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>10</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;10.0.0.5-*&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>260</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>CIDR Mask分组</strong></p><p>此外还可以用CIDR Mask分组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /ip_addresses/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ip_range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;ip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;mask&#34;</span>: <span class=s2>&#34;10.0.0.0/25&#34;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;mask&#34;</span>: <span class=s2>&#34;10.0.0.127/25&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;buckets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;10.0.0.0/25&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.0&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.128&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>128</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;10.0.0.127/25&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.0&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.128&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>128</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>增加key显示</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /ip_addresses/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ip_range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;ip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;keyed&#34;</span>: <span class=nb>true</span> // here
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;buckets&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;*-10.0.0.5&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>10</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;10.0.0.5-*&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>260</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>自定义key显示</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /ip_addresses/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ip_range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;ip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;infinity&#34;</span>, <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;and-beyond&#34;</span>, <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;keyed&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ip_ranges&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;buckets&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;infinity&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>10</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;and-beyond&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;10.0.0.5&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: <span class=m>260</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#对日期类型聚合date-range><h4 id=对日期类型聚合date-range><span class=hanchor arialabel=Anchor># </span>对日期类型聚合：Date Range</h4></a><p>专用于日期值的范围聚合。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;date_range&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;sold&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span>: <span class=s2>&#34;yyyy-MM&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;from&#34;</span>: <span class=s2>&#34;2014-01-01&#34;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> <span class=s2>&#34;to&#34;</span>: <span class=s2>&#34;2014-12-31&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-10.png width=auto alt></p><p>此聚合与Range聚合之间的主要区别在于 from和to值可以在
<a href=https://www.elastic.co/guide/en/elasticsearch/reference/7.12/search-aggregations-bucket-daterange-aggregation.html#date-format-pattern rel=noopener>Date Math表达式</a>中表示，并且还可以指定日期格式，通过该日期格式将返回from and to响应字段。请注意，此聚合包括from值，但<strong>不包括to每个范围的值</strong>。</p><a href=#对柱状图功能histrogram><h4 id=对柱状图功能histrogram><span class=hanchor arialabel=Anchor># </span>对柱状图功能：Histrogram</h4></a><p>直方图 histogram 本质上是就是为柱状图功能设计的。</p><p>创建直方图需要指定一个区间，如果我们要为售价创建一个直方图，可以将间隔设为 20,000。这样做将会在每个 $20,000 档创建一个新桶，然后文档会被分到对应的桶中。</p><p>对于仪表盘来说，我们希望知道每个售价区间内汽车的销量。我们还会想知道每个售价区间内汽车所带来的收入，可以通过对每个区间内已售汽车的售价求和得到。</p><p>可以用 histogram 和一个嵌套的 sum 度量得到我们想要的答案：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;aggs&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;price&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;histogram&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price.keyword&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;interval&#34;</span>: <span class=m>20000</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;aggs&#34;</span>:<span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;revenue&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;sum&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                 <span class=s2>&#34;field&#34;</span> : <span class=s2>&#34;price&#34;</span>
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>             <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>histogram 桶要求两个参数：一个数值字段以及一个定义桶大小间隔。</li><li>sum 度量嵌套在每个售价区间内，用来显示每个区间内的总收入。</li></ol><p>如我们所见，查询是围绕 price 聚合构建的，它包含一个 histogram 桶。它要求字段的类型必须是数值型的同时需要设定分组的间隔范围。 间隔设置为 20,000 意味着我们将会得到如 [0-19999, 20000-39999, &mldr;] 这样的区间。</p><p>接着，我们在直方图内定义嵌套的度量，这个 sum 度量，它会对落入某一具体售价区间的文档中 price 字段的值进行求和。 这可以为我们提供每个售价区间的收入，从而可以发现到底是普通家用车赚钱还是奢侈车赚钱。</p><p>响应结果如下：</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-11.png width=auto alt></p><p>结果很容易理解，不过应该注意到直方图的键值是区间的下限。键 0 代表区间 0-19，999 ，键 20000 代表区间 20，000-39，999 ，等等。</p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-33.png width=auto alt></p><p>当然，我们可以为任何聚合输出的分类和统计结果创建条形图，而不只是 直方图 桶。让我们以最受欢迎 10 种汽车以及它们的平均售价、标准差这些信息创建一个条形图。 我们会用到 terms 桶和 extended_stats 度量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /test-agg-cars/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span> : 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;makes&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;make.keyword&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;size&#34;</span>: <span class=m>10</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;extended_stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述代码会按受欢迎度返回制造商列表以及它们各自的统计信息。我们对其中的 stats.avg 、 stats.count 和 stats.std_deviation 信息特别感兴趣，并用 它们计算出标准差：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>std_err</span> <span class=o>=</span> std_deviation / count
</span></span></code></pre></td></tr></table></div></div><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-12.png width=auto alt></p><p><img src=https://pdai.tech/images/db/es/es-agg-bucket-34.png width=auto alt></p><a href=#metric聚合详解><h2 id=metric聚合详解><span class=hanchor arialabel=Anchor># </span>Metric聚合详解</h2></a><a href=#如何理解metric聚合><h3 id=如何理解metric聚合><span class=hanchor arialabel=Anchor># </span>如何理解metric聚合</h3></a><blockquote><p>metric聚合又如何理解呢？我认为从两个角度：</p></blockquote><p><strong>从分类看</strong>：Metric聚合分析分为<strong>单值分析</strong>和<strong>多值分析</strong>两类</p><p><strong>从功能看</strong>：根据具体的应用场景设计了一些分析api, 比如地理位置，百分数等等</p><blockquote><p>融合上述两个方面，我们可以梳理出大致的一个mind图：</p></blockquote><ul><li><strong>单值分析</strong>: 只输出一个分析结果<ul><li>标准stat型<ul><li><code>avg</code> 平均值</li><li><code>max</code> 最大值</li><li><code>min</code> 最小值</li><li><code>sum</code> 和</li><li><code>value_count</code> 数量</li></ul></li><li>其它类型<ul><li><code>cardinality</code> 基数（distinct去重）</li><li><code>weighted_avg</code> 带权重的avg</li><li><code>median_absolute_deviation</code> 中位值</li></ul></li></ul></li><li><strong>多值分析</strong>: 单值之外的<ul><li>stats型<ul><li><code>stats</code> 包含avg,max,min,sum和count</li><li><code>matrix_stats</code> 针对矩阵模型</li><li><code>extended_stats</code></li><li><code>string_stats</code> 针对字符串</li></ul></li><li>百分数型<ul><li><code>percentiles</code> 百分数范围</li><li><code>percentile_ranks</code> 百分数排行</li></ul></li><li>地理位置型<ul><li><code>geo_bounds</code> Geo bounds</li><li><code>geo_centroid</code> Geo-centroid</li><li><code>geo_line</code> Geo-Line</li></ul></li><li>Top型<ul><li><code>top_hits</code> 分桶后的top hits</li><li><code>top_metrics</code></li></ul></li></ul></li></ul><blockquote><p><strong>通过上述列表（我就不画图了），我们构筑的体系是基于<code>分类</code>和<code>功能</code>，而不是具体的项（比如avg,percentiles&mldr;)；这是不同的认知维度: 具体的项是碎片化，分类和功能这种是你需要构筑的体系</strong>。@pdai</p></blockquote><a href=#单值分析-标准stat类型><h3 id=单值分析-标准stat类型><span class=hanchor arialabel=Anchor># </span>单值分析: 标准stat类型</h3></a><a href=#avg--平均值><h4 id=avg--平均值><span class=hanchor arialabel=Anchor># </span><code>avg</code>   平均值</h4></a><p>计算班级的平均分</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /exams/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;avg_grade&#34;</span>: <span class=o>{</span> <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;grade&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;avg_grade&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 75.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#max--最大值><h4 id=max--最大值><span class=hanchor arialabel=Anchor># </span><code>max</code>   最大值</h4></a><p>计算销售最高价</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;max_price&#34;</span>: <span class=o>{</span> <span class=s2>&#34;max&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;max_price&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;value&#34;</span>: 200.0
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#min--最小值><h3 id=min--最小值><span class=hanchor arialabel=Anchor># </span><code>min</code>   最小值</h3></a><p>计算销售最低价</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;min_price&#34;</span>: <span class=o>{</span> <span class=s2>&#34;min&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;min_price&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 10.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#sum--和><h4 id=sum--和><span class=hanchor arialabel=Anchor># </span><code>sum</code>   和</h4></a><p>计算销售总价</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;constant_score&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;filter&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;hat&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;hat_prices&#34;</span>: <span class=o>{</span> <span class=s2>&#34;sum&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;hat_prices&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 450.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#value_count--数量><h4 id=value_count--数量><span class=hanchor arialabel=Anchor># </span><code>value_count</code>   数量</h4></a><p>销售数量统计</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;types_count&#34;</span> : <span class=o>{</span> <span class=s2>&#34;value_count&#34;</span> : <span class=o>{</span> <span class=s2>&#34;field&#34;</span> : <span class=s2>&#34;type&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;types_count&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: <span class=m>7</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#单值分析-其它类型><h3 id=单值分析-其它类型><span class=hanchor arialabel=Anchor># </span>单值分析: 其它类型</h3></a><a href=#weighted_avg--带权重的avg><h4 id=weighted_avg--带权重的avg><span class=hanchor arialabel=Anchor># </span><code>weighted_avg</code>   带权重的avg</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /exams/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;weighted_grade&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;weighted_avg&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;grade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;weight&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;weight&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;weighted_grade&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 70.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#cardinality--基数distinct去重><h4 id=cardinality--基数distinct去重><span class=hanchor arialabel=Anchor># </span><code>cardinality</code>   基数（distinct去重）</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type_count&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;cardinality&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;type&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type_count&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: <span class=m>3</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#median_absolute_deviation--中位值><h4 id=median_absolute_deviation--中位值><span class=hanchor arialabel=Anchor># </span><code>median_absolute_deviation</code>   中位值</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET reviews/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;review_average&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;avg&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;rating&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;review_variability&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;median_absolute_deviation&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;rating&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;review_average&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 3.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;review_variability&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 2.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#非单值分析stats型><h3 id=非单值分析stats型><span class=hanchor arialabel=Anchor># </span>非单值分析：stats型</h3></a><a href=#stats--包含avgmaxminsum和count><h4 id=stats--包含avgmaxminsum和count><span class=hanchor arialabel=Anchor># </span><code>stats</code>   包含avg,max,min,sum和count</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /exams/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;grades_stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;grade&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;grades_stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;count&#34;</span>: 2,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;min&#34;</span>: 50.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;max&#34;</span>: 100.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;avg&#34;</span>: 75.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sum&#34;</span>: 150.0
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#matrix_stats--针对矩阵模型><h4 id=matrix_stats--针对矩阵模型><span class=hanchor arialabel=Anchor># </span><code>matrix_stats</code>   针对矩阵模型</h4></a><p>以下示例说明了使用矩阵统计量来描述收入与贫困之间的关系。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;statistics&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;matrix_stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;fields&#34;</span>: <span class=o>[</span> <span class=s2>&#34;poverty&#34;</span>, <span class=s2>&#34;income&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;statistics&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;doc_count&#34;</span>: 50,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;fields&#34;</span>: <span class=o>[</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;income&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;count&#34;</span>: 50,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;mean&#34;</span>: 51985.1,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;variance&#34;</span>: 7.383377037755103E7,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;skewness&#34;</span>: 0.5595114003506483,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;kurtosis&#34;</span>: 2.5692365287787124,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;covariance&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;income&#34;</span>: 7.383377037755103E7,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;poverty&#34;</span>: -21093.65836734694
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;correlation&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;income&#34;</span>: 1.0,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;poverty&#34;</span>: -0.8352655256272504
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>, <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;poverty&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;count&#34;</span>: 50,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;mean&#34;</span>: 12.732000000000001,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;variance&#34;</span>: 8.637730612244896,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;skewness&#34;</span>: 0.4516049811903419,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;kurtosis&#34;</span>: 2.8615929677997767,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;covariance&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;income&#34;</span>: -21093.65836734694,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;poverty&#34;</span>: 8.637730612244896
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;correlation&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;income&#34;</span>: -0.8352655256272504,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;poverty&#34;</span>: 1.0
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#extended_stats><h4 id=extended_stats><span class=hanchor arialabel=Anchor># </span><code>extended_stats</code></h4></a><p>根据从汇总文档中提取的数值计算统计信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /exams/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;grades_stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;extended_stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;grade&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的汇总计算了所有文档的成绩统计信息。聚合类型为extended_stats，并且字段设置定义将在其上计算统计信息的文档的数字字段。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;grades_stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;count&#34;</span>: 2,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;min&#34;</span>: 50.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;max&#34;</span>: 100.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;avg&#34;</span>: 75.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sum&#34;</span>: 150.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sum_of_squares&#34;</span>: 12500.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;variance&#34;</span>: 625.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;variance_population&#34;</span>: 625.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;variance_sampling&#34;</span>: 1250.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;std_deviation&#34;</span>: 25.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;std_deviation_population&#34;</span>: 25.0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;std_deviation_sampling&#34;</span>: 35.35533905932738,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;std_deviation_bounds&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upper&#34;</span>: 125.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lower&#34;</span>: 25.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upper_population&#34;</span>: 125.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lower_population&#34;</span>: 25.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;upper_sampling&#34;</span>: 145.71067811865476,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lower_sampling&#34;</span>: 4.289321881345245
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#string_stats--针对字符串><h4 id=string_stats--针对字符串><span class=hanchor arialabel=Anchor># </span><code>string_stats</code>   针对字符串</h4></a><p>用于计算从聚合文档中提取的字符串值的统计信息。这些值可以从特定的关键字字段中检索。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /my-index-000001/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;message_stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;string_stats&#34;</span>: <span class=o>{</span> <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;message.keyword&#34;</span> <span class=o>}</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;message_stats&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;count&#34;</span>: 5,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;min_length&#34;</span>: 24,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;max_length&#34;</span>: 30,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;avg_length&#34;</span>: 28.8,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;entropy&#34;</span>: 3.94617750050791
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#非单值分析百分数型><h3 id=非单值分析百分数型><span class=hanchor arialabel=Anchor># </span>非单值分析：百分数型</h3></a><a href=#percentiles--百分数范围><h4 id=percentiles--百分数范围><span class=hanchor arialabel=Anchor># </span><code>percentiles</code>   百分数范围</h4></a><p>针对从聚合文档中提取的数值计算一个或多个百分位数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET latency/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;load_time_outlier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;percentiles&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;load_time&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，百分位度量标准将生成一定范围的百分位：[1，5，25，50，75，95，99]。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;load_time_outlier&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;values&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;1.0&#34;</span>: 5.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;5.0&#34;</span>: 25.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;25.0&#34;</span>: 165.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;50.0&#34;</span>: 445.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;75.0&#34;</span>: 725.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;95.0&#34;</span>: 945.0,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;99.0&#34;</span>: 985.0
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#percentile_ranks--百分数排行><h4 id=percentile_ranks--百分数排行><span class=hanchor arialabel=Anchor># </span><code>percentile_ranks</code>   百分数排行</h4></a><p>根据从汇总文档中提取的数值计算一个或多个百分位等级。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET latency/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;load_time_ranks&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;percentile_ranks&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;load_time&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;values&#34;</span>: <span class=o>[</span> 500, <span class=m>600</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;load_time_ranks&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;values&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;500.0&#34;</span>: 90.01,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;600.0&#34;</span>: 100.0
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上述结果表示90.01％的页面加载在500ms内完成，而100％的页面加载在600ms内完成。</p><a href=#非单值分析地理位置型><h3 id=非单值分析地理位置型><span class=hanchor arialabel=Anchor># </span>非单值分析：地理位置型</h3></a><a href=#geo_bounds--geo-bounds><h4 id=geo_bounds--geo-bounds><span class=hanchor arialabel=Anchor># </span><code>geo_bounds</code>   Geo bounds</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT /museums
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;mappings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;properties&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;location&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;geo_point&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /museums/_bulk?refresh
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:1<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.374081,4.912350&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;NEMO Science Museum&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:2<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.369219,4.901618&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Museum Het Rembrandthuis&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:3<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.371667,4.914722&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Nederlands Scheepvaartmuseum&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:4<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;51.222900,4.405200&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Letterenhuis&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:5<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;48.861111,2.336389&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Musée du Louvre&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:6<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;48.860000,2.327000&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Musée d&#39;Orsay&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /museums/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;query&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;match&#34;</span>: <span class=o>{</span> <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;musée&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;viewport&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;geo_bounds&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;location&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;wrap_longitude&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的汇总展示了如何针对具有商店业务类型的所有文档计算位置字段的边界框</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;viewport&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;bounds&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;top_left&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;lat&#34;</span>: 48.86111099738628,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;lon&#34;</span>: 2.3269999679178
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;bottom_right&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;lat&#34;</span>: 48.85999997612089,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;lon&#34;</span>: 2.3363889567553997
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#geo_centroid--geo-centroid><h4 id=geo_centroid--geo-centroid><span class=hanchor arialabel=Anchor># </span><code>geo_centroid</code>   Geo-centroid</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT /museums
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;mappings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;properties&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;location&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;geo_point&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /museums/_bulk?refresh
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:1<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.374081,4.912350&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Amsterdam&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;NEMO Science Museum&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:2<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.369219,4.901618&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Amsterdam&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Museum Het Rembrandthuis&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:3<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;52.371667,4.914722&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Amsterdam&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Nederlands Scheepvaartmuseum&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:4<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;51.222900,4.405200&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Antwerp&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Letterenhuis&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:5<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;48.861111,2.336389&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Paris&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Musée du Louvre&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>:<span class=o>{</span><span class=s2>&#34;_id&#34;</span>:6<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;location&#34;</span>: <span class=s2>&#34;48.860000,2.327000&#34;</span>, <span class=s2>&#34;city&#34;</span>: <span class=s2>&#34;Paris&#34;</span>, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;Musée d&#39;Orsay&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /museums/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;centroid&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;geo_centroid&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;location&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的汇总显示了如何针对所有具有犯罪类型的盗窃文件计算位置字段的质心。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;centroid&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;location&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lat&#34;</span>: 51.00982965203002,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lon&#34;</span>: 3.9662131341174245
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;count&#34;</span>: <span class=m>6</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#geo_line--geo-line><h4 id=geo_line--geo-line><span class=hanchor arialabel=Anchor># </span><code>geo_line</code>   Geo-Line</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PUT <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;mappings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dynamic&#34;</span>: <span class=s2>&#34;strict&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;_source&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;enabled&#34;</span>: <span class=nb>false</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;properties&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;my_location&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;geo_point&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;group&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;keyword&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;@timestamp&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;date&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /test/_bulk?refresh
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;my_location&#34;</span>: <span class=o>{</span><span class=s2>&#34;lat&#34;</span>:37.3450570, <span class=s2>&#34;lon&#34;</span>: -122.0499820<span class=o>}</span>, <span class=s2>&#34;@timestamp&#34;</span>: <span class=s2>&#34;2013-09-06T16:00:36&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;my_location&#34;</span>: <span class=o>{</span><span class=s2>&#34;lat&#34;</span>: 37.3451320, <span class=s2>&#34;lon&#34;</span>: -122.0499820<span class=o>}</span>, <span class=s2>&#34;@timestamp&#34;</span>: <span class=s2>&#34;2013-09-06T16:00:37Z&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;my_location&#34;</span>: <span class=o>{</span><span class=s2>&#34;lat&#34;</span>: 37.349283, <span class=s2>&#34;lon&#34;</span>: -122.0505010<span class=o>}</span>, <span class=s2>&#34;@timestamp&#34;</span>: <span class=s2>&#34;2013-09-06T16:00:37Z&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /test/_search?filter_path<span class=o>=</span>aggregations
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;line&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;geo_line&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;point&#34;</span>: <span class=o>{</span><span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;my_location&#34;</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sort&#34;</span>: <span class=o>{</span><span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;@timestamp&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>将存储桶中的所有geo_point值聚合到由所选排序字段排序的LineString中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;line&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;Feature&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;geometry&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span> : <span class=s2>&#34;LineString&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;coordinates&#34;</span> : <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>[</span>
</span></span><span class=line><span class=cl>            -122.049982,
</span></span><span class=line><span class=cl>            37.345057
</span></span><span class=line><span class=cl>          <span class=o>]</span>,
</span></span><span class=line><span class=cl>          <span class=o>[</span>
</span></span><span class=line><span class=cl>            -122.050501,
</span></span><span class=line><span class=cl>            37.349283
</span></span><span class=line><span class=cl>          <span class=o>]</span>,
</span></span><span class=line><span class=cl>          <span class=o>[</span>
</span></span><span class=line><span class=cl>            -122.049982,
</span></span><span class=line><span class=cl>            37.345132
</span></span><span class=line><span class=cl>          <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;properties&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;complete&#34;</span> : <span class=nb>true</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#非单值分析top型><h3 id=非单值分析top型><span class=hanchor arialabel=Anchor># </span>非单值分析：Top型</h3></a><a href=#top_hits--分桶后的top-hits><h4 id=top_hits--分桶后的top-hits><span class=hanchor arialabel=Anchor># </span><code>top_hits</code>   分桶后的top hits</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search?size<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;top_tags&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;terms&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;type&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;size&#34;</span>: <span class=m>3</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;top_sales_hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;top_hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;date&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;order&#34;</span>: <span class=s2>&#34;desc&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;_source&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;includes&#34;</span>: <span class=o>[</span> <span class=s2>&#34;date&#34;</span>, <span class=s2>&#34;price&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;size&#34;</span>: <span class=m>1</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;top_tags&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>       <span class=s2>&#34;doc_count_error_upper_bound&#34;</span>: 0,
</span></span><span class=line><span class=cl>       <span class=s2>&#34;sum_other_doc_count&#34;</span>: 0,
</span></span><span class=line><span class=cl>       <span class=s2>&#34;buckets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;hat&#34;</span>,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;doc_count&#34;</span>: 3,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;top_sales_hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;total&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;value&#34;</span>: 3,
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;relation&#34;</span>: <span class=s2>&#34;eq&#34;</span>
</span></span><span class=line><span class=cl>                   <span class=o>}</span>,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;max_score&#34;</span>: null,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;hits&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                      <span class=o>{</span>
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_index&#34;</span>: <span class=s2>&#34;sales&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_type&#34;</span>: <span class=s2>&#34;_doc&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_id&#34;</span>: <span class=s2>&#34;AVnNBmauCQpcRyxw6ChK&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_source&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;date&#34;</span>: <span class=s2>&#34;2015/03/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;price&#34;</span>: <span class=m>200</span>
</span></span><span class=line><span class=cl>                         <span class=o>}</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                            <span class=m>1425168000000</span>
</span></span><span class=line><span class=cl>                         <span class=o>]</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_score&#34;</span>: null
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                   <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>             <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;t-shirt&#34;</span>,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;doc_count&#34;</span>: 3,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;top_sales_hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;total&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;value&#34;</span>: 3,
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;relation&#34;</span>: <span class=s2>&#34;eq&#34;</span>
</span></span><span class=line><span class=cl>                   <span class=o>}</span>,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;max_score&#34;</span>: null,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;hits&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                      <span class=o>{</span>
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_index&#34;</span>: <span class=s2>&#34;sales&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_type&#34;</span>: <span class=s2>&#34;_doc&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_id&#34;</span>: <span class=s2>&#34;AVnNBmauCQpcRyxw6ChL&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_source&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;date&#34;</span>: <span class=s2>&#34;2015/03/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;price&#34;</span>: <span class=m>175</span>
</span></span><span class=line><span class=cl>                         <span class=o>}</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                            <span class=m>1425168000000</span>
</span></span><span class=line><span class=cl>                         <span class=o>]</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_score&#34;</span>: null
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                   <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>             <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;key&#34;</span>: <span class=s2>&#34;bag&#34;</span>,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;doc_count&#34;</span>: 1,
</span></span><span class=line><span class=cl>             <span class=s2>&#34;top_sales_hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;hits&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;total&#34;</span> : <span class=o>{</span>
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;value&#34;</span>: 1,
</span></span><span class=line><span class=cl>                       <span class=s2>&#34;relation&#34;</span>: <span class=s2>&#34;eq&#34;</span>
</span></span><span class=line><span class=cl>                   <span class=o>}</span>,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;max_score&#34;</span>: null,
</span></span><span class=line><span class=cl>                   <span class=s2>&#34;hits&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                      <span class=o>{</span>
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_index&#34;</span>: <span class=s2>&#34;sales&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_type&#34;</span>: <span class=s2>&#34;_doc&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_id&#34;</span>: <span class=s2>&#34;AVnNBmatCQpcRyxw6ChH&#34;</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_source&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;date&#34;</span>: <span class=s2>&#34;2015/01/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;price&#34;</span>: <span class=m>150</span>
</span></span><span class=line><span class=cl>                         <span class=o>}</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                            <span class=m>1420070400000</span>
</span></span><span class=line><span class=cl>                         <span class=o>]</span>,
</span></span><span class=line><span class=cl>                         <span class=s2>&#34;_score&#34;</span>: null
</span></span><span class=line><span class=cl>                      <span class=o>}</span>
</span></span><span class=line><span class=cl>                   <span class=o>]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>             <span class=o>}</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>       <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#top_metrics><h4 id=top_metrics><span class=hanchor arialabel=Anchor># </span><code>top_metrics</code></h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /test/_bulk?refresh
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;s&#34;</span>: 1, <span class=s2>&#34;m&#34;</span>: 3.1415<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;s&#34;</span>: 2, <span class=s2>&#34;m&#34;</span>: 1.0<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;index&#34;</span>: <span class=o>{}}</span>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;s&#34;</span>: 3, <span class=s2>&#34;m&#34;</span>: 2.71828<span class=o>}</span>
</span></span><span class=line><span class=cl>POST /test/_search?filter_path<span class=o>=</span>aggregations
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tm&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;top_metrics&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;metrics&#34;</span>: <span class=o>{</span><span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;m&#34;</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sort&#34;</span>: <span class=o>{</span><span class=s2>&#34;s&#34;</span>: <span class=s2>&#34;desc&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tm&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;top&#34;</span>: <span class=o>[</span> <span class=o>{</span><span class=s2>&#34;sort&#34;</span>: <span class=o>[</span>3<span class=o>]</span>, <span class=s2>&#34;metrics&#34;</span>: <span class=o>{</span><span class=s2>&#34;m&#34;</span>: 2.718280076980591 <span class=o>}</span> <span class=o>}</span> <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#pipline聚合详解><h2 id=pipline聚合详解><span class=hanchor arialabel=Anchor># </span>Pipline聚合详解</h2></a><a href=#如何理解pipeline聚合><h3 id=如何理解pipeline聚合><span class=hanchor arialabel=Anchor># </span>如何理解pipeline聚合</h3></a><p>如何理解管道聚合呢？最重要的是要站在设计者角度看这个功能的要实现的目的：让上一步的聚合结果成为下一个聚合的输入，这就是管道。</p><a href=#管道机制的常见场景><h4 id=管道机制的常见场景><span class=hanchor arialabel=Anchor># </span>管道机制的常见场景</h4></a><a href=#责任链模式><h5 id=责任链模式><span class=hanchor arialabel=Anchor># </span>责任链模式</h5></a><p>管道机制在设计模式上属于责任链模式，如果你不理解，请参看如下文章：</p><p><a rel=noopener class="internal-link broken" data-src=/md/dev-spec/pattern/15_chain.html>责任链模式(Chain of responsibility pattern)</a>: 通过责任链模式, 你可以为某个请求创建一个对象链. 每个对象依序检查此请求并对其进行处理或者将它传给链中的下一个对象。</p><a href=#filterchain><h5 id=filterchain><span class=hanchor arialabel=Anchor># </span>FilterChain</h5></a><p>在软件开发的常接触的责任链模式是FilterChain，它体现在很多软件设计中：</p><p><strong>比如Spring Security框架中</strong></p><p><img src=https://pdai.tech/images/tomcat/tomcat-x-pipline-6.jpg width=auto alt></p><p><strong>比如HttpServletRequest处理的过滤器中</strong></p><p>当一个request过来的时候，需要对这个request做一系列的加工，使用责任链模式可以使每个加工组件化，减少耦合。也可以使用在当一个request过来的时候，需要找到合适的加工方式。当一个加工方式不适合这个request的时候，传递到下一个加工方法，该加工方式再尝试对request加工。</p><p><img src=https://pdai.tech/images/tomcat/tomcat-x-pipline-5.jpg width=auto alt></p><a href=#elasticsearch设计管道机制><h4 id=elasticsearch设计管道机制><span class=hanchor arialabel=Anchor># </span>ElasticSearch设计管道机制</h4></a><p>简单而言：让上一步的聚合结果成为下一个聚合的输入，这就是管道。</p><p>接下来，无非就是对不同类型的聚合有接口的支撑，比如：</p><blockquote><p>第一个维度：管道聚合有很多不同<strong>类型</strong>，每种类型都与其他聚合计算不同的信息，但是可以将这些类型分为两类：</p></blockquote><p><strong>父级</strong> 父级聚合的输出提供了一组管道聚合，它可以计算新的存储桶或新的聚合以添加到现有存储桶中。</p><p><strong>兄弟</strong> 同级聚合的输出提供的管道聚合，并且能够计算与该同级聚合处于同一级别的新聚合。</p><blockquote><p>第二个维度：根据<strong>功能设计</strong>的意图</p></blockquote><p>比如前置聚合可能是Bucket聚合，后置的可能是基于Metric聚合，那么它就可以成为一类管道</p><p>进而引出了：<code>xxx bucket</code>(是不是很容易理解了 @pdai)</p><p><strong>Bucket聚合 -> Metric聚合</strong>： bucket聚合的结果，成为下一步metric聚合的输入</p><ul><li>Average bucket</li><li>Min bucket</li><li>Max bucket</li><li>Sum bucket</li><li>Stats bucket</li><li>Extended stats bucket</li></ul><p>对构建体系而言，理解上面的已经够了，其它的类型不过是锦上添花而言。</p><a href=#一些例子><h3 id=一些例子><span class=hanchor arialabel=Anchor># </span>一些例子</h3></a><a href=#average-bucket-聚合><h4 id=average-bucket-聚合><span class=hanchor arialabel=Anchor># </span>Average bucket 聚合</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST _search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;sales_per_month&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;date_histogram&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;date&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;calendar_interval&#34;</span>: <span class=s2>&#34;month&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;sum&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;avg_monthly_sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>// tag::avg-bucket-agg-syntax<span class=o>[]</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;avg_bucket&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;buckets_path&#34;</span>: <span class=s2>&#34;sales_per_month&gt;sales&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gap_policy&#34;</span>: <span class=s2>&#34;skip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span>: <span class=s2>&#34;#,##0.00;(#,##0.00)&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>// end::avg-bucket-agg-syntax<span class=o>[]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>嵌套的bucket聚合：聚合出按月价格的直方图</p><p>Metic聚合：对上面的聚合再求平均值。</p><p><strong>字段类型</strong>：</p><p>buckets_path：指定聚合的名称，支持多级嵌套聚合。</p><p>gap_policy 当管道聚合遇到不存在的值，有点类似于term等聚合的(missing)时所采取的策略，可选择值为：skip、insert_zeros。</p><p>skip：此选项将丢失的数据视为bucket不存在。它将跳过桶并使用下一个可用值继续计算。</p><p>format 用于格式化聚合桶的输出(key)。</p><p>输出结果如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;took&#34;</span>: 11,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;timed_out&#34;</span>: false,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;_shards&#34;</span>: ...,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hits&#34;</span>: ...,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;sales_per_month&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;buckets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/01/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: 1420070400000,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: 3,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;value&#34;</span>: 550.0
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/02/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: 1422748800000,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: 2,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;value&#34;</span>: 60.0
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/03/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;key&#34;</span>: 1425168000000,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;doc_count&#34;</span>: 2,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;value&#34;</span>: 375.0
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;avg_monthly_sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: 328.33333333333333,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value_as_string&#34;</span>: <span class=s2>&#34;328.33&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#stats-bucket-聚合><h4 id=stats-bucket-聚合><span class=hanchor arialabel=Anchor># </span>Stats bucket 聚合</h4></a><p>进一步的stat bucket也很容易理解了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>POST /sales/_search
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;size&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;sales_per_month&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;date_histogram&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;date&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;calendar_interval&#34;</span>: <span class=s2>&#34;month&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;aggs&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;sum&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;field&#34;</span>: <span class=s2>&#34;price&#34;</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;stats_monthly_sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;stats_bucket&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;buckets_path&#34;</span>: <span class=s2>&#34;sales_per_month&gt;sales&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>返回</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;took&#34;</span>: 11,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;timed_out&#34;</span>: false,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;_shards&#34;</span>: ...,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;hits&#34;</span>: ...,
</span></span><span class=line><span class=cl>   <span class=s2>&#34;aggregations&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sales_per_month&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;buckets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/01/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key&#34;</span>: 1420070400000,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;doc_count&#34;</span>: 3,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;value&#34;</span>: 550.0
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/02/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key&#34;</span>: 1422748800000,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;doc_count&#34;</span>: 2,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;value&#34;</span>: 60.0
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=o>{</span>
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key_as_string&#34;</span>: <span class=s2>&#34;2015/03/01 00:00:00&#34;</span>,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;key&#34;</span>: 1425168000000,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;doc_count&#34;</span>: 2,
</span></span><span class=line><span class=cl>               <span class=s2>&#34;sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;value&#34;</span>: 375.0
</span></span><span class=line><span class=cl>               <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>         <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;stats_monthly_sales&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;count&#34;</span>: 3,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;min&#34;</span>: 60.0,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;max&#34;</span>: 550.0,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;avg&#34;</span>: 328.3333333333333,
</span></span><span class=line><span class=cl>         <span class=s2>&#34;sum&#34;</span>: 985.0
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://obsidian.codeplayer.org/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Patrick Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://obsidian.codeplayer.org/>Home</a></li><li><a href=https://github.com/PetrusZ>GitHub</a></li><li><a href=https://t.me/Petrus_Z>Telegram</a></li><li><a href=mailto:silencly07@gmail.com>Email</a></li></ul></footer></div><hr><script src=https://giscus.app/client.js data-repo=PetrusZ/ObsidianPublish data-repo-id=R_kgDOJTGL0A data-category=Announcements data-category-id=DIC_kwDOJTGL0M4CVohQ data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></div></body></html>